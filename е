let socket;
let lastEventKey = "";
 // Ğ²Ğ¼ĞµÑÑ‚Ğ¾ lastMessage 
function connectWS() 
    { socket = new WebSocket("ws://localhost:8765"); 
    socket.addEventListener("open", () => console.log("ğŸ”Œ WebSocket Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚")); 
    socket.addEventListener("close", () => setTimeout(connectWS, 2000)); 
    socket.addEventListener("error", (err) => console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° WS:", err)); 
    }
    connectWS();
    setInterval(() => { 
        const donations = document.querySelectorAll("li.js-systemCommentLine"); 
        if (donations.length > 0) { 
        const last = donations[donations.length - 1].innerText.trim(); // Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° ÑĞ»Ğ¾Ğ²Ğ¾ "Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ»" if (/Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ»/i.test(last)) { // Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ: user_id + Ñ‚ĞµĞºÑÑ‚ const idMatch = last.match(/\b([0-9a-f]{32})\b/i); const userId = idMatch ? idMatch[1] : null; const eventKey = (userId || "") + "|" + last; if (eventKey !== lastEventKey) { lastEventKey = eventKey; let name = null; let amount = null; const nameMatch = last.match(/^(.+?)\s+Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ»/i); if (nameMatch) name = nameMatch[1].trim(); const amountMatch = last.match(/Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ»\s+(\d+)/i); if (amountMatch) amount = parseInt(amountMatch[1], 10); const gifts = { "ĞšĞ¾Ğ½Ñ„ĞµÑ‚Ğ°":10, "Ğ¡ĞµÑ€Ğ´Ñ†Ğµ":10, "ĞŸĞ¾Ñ†ĞµĞ»ÑƒĞ¹":100, "Ğ¤ĞµĞ¹ĞµÑ€Ğ²ĞµÑ€Ğº":1000, "Ğ¨Ğ°Ğ¼Ğ¿Ğ°Ğ½ÑĞºĞ¾Ğµ":10000 }; for (let gift in gifts) { if (last.toLowerCase().includes(gift.toLowerCase())) amount = gifts[gift]; } // fallback: ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ â†’ amount = 1 if (amount === null) amount = 1; if (socket && socket.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ text: last, name: name, user_id: userId, amount: amount })); console.log("ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² WebSocket:", { name, userId, amount, text: last }); } } } } }, 3000);
        ?? ä¸Šç´šãƒ¬ãƒ™ãƒ«
1500ãƒã‚¤ãƒ³ãƒˆ â†’ ç‰¹åˆ¥ã«åå‰ã‚’å‘¼ã‚“ã§ã‚ã’ã‚‹â™¡ 
2000ãƒã‚¤ãƒ³ãƒˆ â†’ ã€Œç§˜å¯†ã®è¨€è‘‰ã€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ ??

?? VIPãƒ¬ãƒ™ãƒ« (VIPâ€‘ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ)

3000+ãƒã‚¤ãƒ³ãƒˆ â†’ VIPã‚ã‚ŠãŒã¨ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + ãƒˆãƒƒãƒ—ãƒ‰ãƒãƒ¼ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«æ²è¼‰

5000+ãƒã‚¤ãƒ³ãƒˆ â†’ ä½“ã«ã‚ãªãŸã®åå‰ã‚’æ›¸ã„ã¡ã‚ƒã†â€¦??


Ğ¼Ğ½Ğµ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ°Ñ.
 Ñ Ğ±Ñ‹ Ñ…Ğ¾Ñ‚ĞµĞ»Ğ° Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑÑ ĞµĞ¹ Ñ Ğ¼Ğ¾ĞµĞ¹ Ğ¿Ğ¾Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ñ‚Ğ¾Ğ¶Ğµ ÑÑ‚Ñ€Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğ° fc2 live.
  Ğ½Ğ¾ Ñƒ Ğ½ĞµĞµ Ğ½ĞµÑ‚ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ²Ğ¾ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½ĞµĞ³Ñ€Ğ¾ĞºĞ¾Ğ¼ 
  Ğ´Ğ° Ğ¸ Ñ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ´Ğ·Ğ°Ğ±Ñ‹Ğ»Ğ° Ñ‡Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾Ğ± 
  Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾. Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ ÑĞµÑ€Ğ²ĞµÑ€ 
  Ğ´Ğ»Ñ Ğ½Ğ°Ñ Ğ´Ğ²Ğ¾Ğ¸Ñ… Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ngrok. Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸
   ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµĞ¹
   <script>
    function removeMember(userId) {
      fetch("/remove_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.remove();
        } else {
          alert("âŒ " + data.message);
        }
      })
      .catch(() => alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"));
    }

    function blockMember(userId) {
      fetch("/block_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.classList.add("blocked");
        } else {
          alert("âŒ " + data.message);
        }
      })
      .catch(() => alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸"));
    }

    // Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ
    document.querySelectorAll(".date").forEach(el => {
      const raw = el.textContent.trim();
      if (!raw) return;
      const iso = raw.replace(" ", "T"); // "YYYY-MM-DD HH:MM:SS" â†’ ISO
      const d = new Date(iso);
      if (!isNaN(d.getTime())) {
        el.textContent = d.toLocaleString("ru-RU", {
          day: "numeric",
          month: "long",
          hour: "2-digit",
          minute: "2-digit"
        });
      }
    });
    // Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº WebSocket
    let socket;

    function connectWS() {
      socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

      socket.onopen = () => console.log("âœ… WS Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚");
      socket.onclose = () => {
        console.log("âŒ WS Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚, Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ...");
        setTimeout(connectWS, 2000); // Ğ°Ğ²Ñ‚Ğ¾â€‘Ñ€ĞµĞºĞ¾Ğ½Ğ½ĞµĞºÑ‚
      };

      
      socket.onmessage = (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.vip_update && data.user_id) {
          console.log("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ:", data.user_id);
          refreshVipCard(data.user_id).then(() => {
            resortCards("{{ request.args.get('sort', 'total') }}");
          });
        }

      };



    }
    connectWS();

    // Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ°
    async function refreshVipList() {
      try {
        const res = await fetch("/vip_data"); // ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¾Ñ‚Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ JSON
        const data = await res.json();
        const grid = document.querySelector(".card-grid");
        grid.innerHTML = "";

        Object.entries(data.members || {}).forEach(([user_id, info]) => {
          const card = document.createElement("div");
          card.className = "vip-card" + (info.blocked ? " blocked" : "");
          card.id = "card_" + user_id;
          card.innerHTML = `
            <form method="POST">
              <input type="hidden" name="user_id" value="${user_id}">
              <h3><input type="text" name="name" value="${info.name}"></h3>
              <input type="text" name="notes" value="${info.notes || ""}" placeholder="Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸">
              <div class="meta">
                ğŸ’— ${info.total} | ğŸ“… ${info.login_count} Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ²<br>
                ğŸ•’ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚: ${info.last_login}<br>
                ğŸ†” ID: <code>${user_id}</code>
              </div>
              <div class="actions">
                <button type="submit">ğŸ’¾</button>
                <button type="button" onclick="removeMember('${user_id}')">ğŸ—‘ï¸</button>
                <button type="button" onclick="blockMember('${user_id}')">ğŸš«</button>
              </div>
            </form>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.warn("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ VIPâ€‘Ğ»Ğ¸ÑÑ‚Ğ°:", e);
      }
    }
    async function refreshVipCard(userId) {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const info = data.members[userId];
        if (!info) return; // ĞµÑĞ»Ğ¸ Ñ‚Ğ°ĞºĞ¾Ğ³Ğ¾ ÑĞ·ĞµÑ€Ğ° Ğ½ĞµÑ‚ â€” Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼

        const card = document.getElementById("card_" + userId);
        const newCard = document.createElement("div");
        newCard.className = "vip-card" + (info.blocked ? " blocked" : "");
        newCard.id = "card_" + userId;
        newCard.innerHTML = `
          <form method="POST">
            <input type="hidden" name="user_id" value="${userId}">
            <h3><input type="text" name="name" value="${info.name}"></h3>
            <input type="text" name="notes" value="${info.notes || ""}" placeholder="Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸">
            <div class="meta">
              ğŸ’— ${info.total} | ğŸ“… ${info.login_count} Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ²<br>
              ğŸ•’ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚: ${info.last_login}<br>
              ğŸ†” ID: <code>${userId}</code>
            </div>
            <div class="actions">
              <button type="submit">ğŸ’¾</button>
              <button type="button" onclick="removeMember('${userId}')">ğŸ—‘ï¸</button>
              <button type="button" onclick="blockMember('${userId}')">ğŸš«</button>
            </div>
          </form>
        `;

        if (card) {
          card.replaceWith(newCard); // Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€ÑƒÑ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ
        } else {
          document.querySelector(".card-grid").appendChild(newCard); // ĞµÑĞ»Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼
        }
      } catch (e) {
        console.warn("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸:", e);
      }
    }

    function resortCards(sortBy) {
      const grid = document.querySelector(".card-grid");
      const cards = Array.from(grid.children);

      cards.sort((a, b) => {
        // Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
        const getValue = (card, selector, fallback = 0) => {
          const el = card.querySelector(selector);
          if (!el) return fallback;
          const text = el.textContent;
          const num = parseInt(text.replace(/\D+/g, ""));
          return isNaN(num) ? fallback : num;
        };

        if (sortBy === "total") {
          return getValue(b, ".meta", 0) - getValue(a, ".meta", 0);
        }
        if (sortBy === "login_count") {
          return getValue(b, ".meta", 0) - getValue(a, ".meta", 0);
        }
        if (sortBy === "last_login") {
          const dateA = new Date(a.querySelector(".date")?.textContent || 0);
          const dateB = new Date(b.querySelector(".date")?.textContent || 0);
          return dateB - dateA;
        }
        return 0;
      });

      // Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ DOM
      grid.innerHTML = "";
      cards.forEach(c => grid.appendChild(c));
    }


  </script>