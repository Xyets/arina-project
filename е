let socket;
let lastEventKey = "";
 // –≤–º–µ—Å—Ç–æ lastMessage 
function connectWS() 
    { socket = new WebSocket("ws://localhost:8765"); 
    socket.addEventListener("open", () => console.log("üîå WebSocket –æ—Ç–∫—Ä—ã—Ç")); 
    socket.addEventListener("close", () => setTimeout(connectWS, 2000)); 
    socket.addEventListener("error", (err) => console.error("‚ùå –û—à–∏–±–∫–∞ WS:", err)); 
    }
    connectWS();
    setInterval(() => { 
        const donations = document.querySelectorAll("li.js-systemCommentLine"); 
        if (donations.length > 0) { 
        const last = donations[donations.length - 1].innerText.trim(); // –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–ª–æ–≤–æ "–ø–æ–¥–∞—Ä–∏–ª" if (/–ø–æ–¥–∞—Ä–∏–ª/i.test(last)) { // —Ñ–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —Å–æ–±—ã—Ç–∏—è: user_id + —Ç–µ–∫—Å—Ç const idMatch = last.match(/\b([0-9a-f]{32})\b/i); const userId = idMatch ? idMatch[1] : null; const eventKey = (userId || "") + "|" + last; if (eventKey !== lastEventKey) { lastEventKey = eventKey; let name = null; let amount = null; const nameMatch = last.match(/^(.+?)\s+–ø–æ–¥–∞—Ä–∏–ª/i); if (nameMatch) name = nameMatch[1].trim(); const amountMatch = last.match(/–ø–æ–¥–∞—Ä–∏–ª\s+(\d+)/i); if (amountMatch) amount = parseInt(amountMatch[1], 10); const gifts = { "–ö–æ–Ω—Ñ–µ—Ç–∞":10, "–°–µ—Ä–¥—Ü–µ":10, "–ü–æ—Ü–µ–ª—É–π":100, "–§–µ–π–µ—Ä–≤–µ—Ä–∫":1000, "–®–∞–º–ø–∞–Ω—Å–∫–æ–µ":10000 }; for (let gift in gifts) { if (last.toLowerCase().includes(gift.toLowerCase())) amount = gifts[gift]; } // fallback: –µ—Å–ª–∏ –ø–æ–¥–∞—Ä–æ–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ‚Üí amount = 1 if (amount === null) amount = 1; if (socket && socket.readyState === WebSocket.OPEN) { socket.send(JSON.stringify({ text: last, name: name, user_id: userId, amount: amount })); console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ WebSocket:", { name, userId, amount, text: last }); } } } } }, 3000);
        ?? ‰∏äÁ¥ö„É¨„Éô„É´
1500„Éù„Ç§„É≥„Éà ‚Üí ÁâπÂà•„Å´ÂêçÂâç„ÇíÂëº„Çì„Åß„ÅÇ„Åí„Çã‚ô° 
2000„Éù„Ç§„É≥„Éà ‚Üí „ÄåÁßòÂØÜ„ÅÆË®ÄËëâ„Äç„Éó„É¨„Çº„É≥„Éà ??

?? VIP„É¨„Éô„É´ (VIP‚Äë—É—Ä–æ–≤–µ–Ω—å)

3000+„Éù„Ç§„É≥„Éà ‚Üí VIP„ÅÇ„Çä„Åå„Å®„ÅÜ„É°„ÉÉ„Çª„Éº„Ç∏ + „Éà„ÉÉ„Éó„Éâ„Éç„Éº„Çø„Éº„É™„Çπ„Éà„Å´Êé≤Ëºâ

5000+„Éù„Ç§„É≥„Éà ‚Üí ‰Ωì„Å´„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÊõ∏„ÅÑ„Å°„ÇÉ„ÅÜ‚Ä¶??


–º–Ω–µ –∫–∞–∂–µ—Ç—Å—è —á—Ç–æ –º–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–∞—è.
 —è –±—ã —Ö–æ—Ç–µ–ª–∞ –ø–æ–¥–µ–ª–∏—Ç—Å—è –µ–π —Å –º–æ–µ–π –ø–æ–¥—Ä—É–≥–æ–π –∫–æ—Ç–æ—Ä–∞—è —Ç–æ–∂–µ —Å—Ç—Ä–∏–º–∏—Ç –Ω–∞ fc2 live.
  –Ω–æ —É –Ω–µ–µ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–µ–≥—Ä–æ–∫–æ–º 
  –¥–∞ –∏ —è —É–∂–µ –ø–æ–¥–∑–∞–±—ã–ª–∞ —á—Ç–æ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —á—Ç–æ–± 
  –ø—Ä–æ–≥—Ä–∞–º–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –º–æ–∂–Ω–æ –ª–∏ –∫—É–ø–∏—Ç—å —Å–µ—Ä–≤–µ—Ä 
  –¥–ª—è –Ω–∞—Å –¥–≤–æ–∏—Ö –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ngrok. –∏ –º–æ–∂–Ω–æ –ª–∏
   —Å–¥–µ–ª–∞—Ç—å –º–æ—é –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–π
   <script>
    function removeMember(userId) {
      fetch("/remove_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.remove();
        } else {
          alert("‚ùå " + data.message);
        }
      })
      .catch(() => alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"));
    }

    function blockMember(userId) {
      fetch("/block_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.classList.add("blocked");
        } else {
          alert("‚ùå " + data.message);
        }
      })
      .catch(() => alert("‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"));
    }

    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    document.querySelectorAll(".date").forEach(el => {
      const raw = el.textContent.trim();
      if (!raw) return;
      const iso = raw.replace(" ", "T"); // "YYYY-MM-DD HH:MM:SS" ‚Üí ISO
      const d = new Date(iso);
      if (!isNaN(d.getTime())) {
        el.textContent = d.toLocaleString("ru-RU", {
          day: "numeric",
          month: "long",
          hour: "2-digit",
          minute: "2-digit"
        });
      }
    });
    // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    let socket;

    function connectWS() {
      socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

      socket.onopen = () => console.log("‚úÖ WS –æ—Ç–∫—Ä—ã—Ç");
      socket.onclose = () => {
        console.log("‚ùå WS –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");
        setTimeout(connectWS, 2000); // –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
      };

      
      socket.onmessage = (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.vip_update && data.user_id) {
          console.log("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É:", data.user_id);
          refreshVipCard(data.user_id).then(() => {
            resortCards("{{ request.args.get('sort', 'total') }}");
          });
        }

      };



    }
    connectWS();

    // —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
    async function refreshVipList() {
      try {
        const res = await fetch("/vip_data"); // —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–¥–∞–≤–∞—Ç—å JSON
        const data = await res.json();
        const grid = document.querySelector(".card-grid");
        grid.innerHTML = "";

        Object.entries(data.members || {}).forEach(([user_id, info]) => {
          const card = document.createElement("div");
          card.className = "vip-card" + (info.blocked ? " blocked" : "");
          card.id = "card_" + user_id;
          card.innerHTML = `
            <form method="POST">
              <input type="hidden" name="user_id" value="${user_id}">
              <h3><input type="text" name="name" value="${info.name}"></h3>
              <input type="text" name="notes" value="${info.notes || ""}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
              <div class="meta">
                üíó ${info.total} | üìÖ ${info.login_count} –≤—Ö–æ–¥–æ–≤<br>
                üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: ${info.last_login}<br>
                üÜî ID: <code>${user_id}</code>
              </div>
              <div class="actions">
                <button type="submit">üíæ</button>
                <button type="button" onclick="removeMember('${user_id}')">üóëÔ∏è</button>
                <button type="button" onclick="blockMember('${user_id}')">üö´</button>
              </div>
            </form>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è VIP‚Äë–ª–∏—Å—Ç–∞:", e);
      }
    }
    async function refreshVipCard(userId) {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const info = data.members[userId];
        if (!info) return; // –µ—Å–ª–∏ —Ç–∞–∫–æ–≥–æ —é–∑–µ—Ä–∞ –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

        const card = document.getElementById("card_" + userId);
        const newCard = document.createElement("div");
        newCard.className = "vip-card" + (info.blocked ? " blocked" : "");
        newCard.id = "card_" + userId;
        newCard.innerHTML = `
          <form method="POST">
            <input type="hidden" name="user_id" value="${userId}">
            <h3><input type="text" name="name" value="${info.name}"></h3>
            <input type="text" name="notes" value="${info.notes || ""}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
            <div class="meta">
              üíó ${info.total} | üìÖ ${info.login_count} –≤—Ö–æ–¥–æ–≤<br>
              üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: ${info.last_login}<br>
              üÜî ID: <code>${userId}</code>
            </div>
            <div class="actions">
              <button type="submit">üíæ</button>
              <button type="button" onclick="removeMember('${userId}')">üóëÔ∏è</button>
              <button type="button" onclick="blockMember('${userId}')">üö´</button>
            </div>
          </form>
        `;

        if (card) {
          card.replaceWith(newCard); // –∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        } else {
          document.querySelector(".card-grid").appendChild(newCard); // –µ—Å–ª–∏ –Ω–æ–≤–æ–π ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:", e);
      }
    }

    function resortCards(sortBy) {
      const grid = document.querySelector(".card-grid");
      const cards = Array.from(grid.children);

      cards.sort((a, b) => {
        // –∏–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫
        const getValue = (card, selector, fallback = 0) => {
          const el = card.querySelector(selector);
          if (!el) return fallback;
          const text = el.textContent;
          const num = parseInt(text.replace(/\D+/g, ""));
          return isNaN(num) ? fallback : num;
        };

        if (sortBy === "total") {
          return getValue(b, ".meta", 0) - getValue(a, ".meta", 0);
        }
        if (sortBy === "login_count") {
          return getValue(b, ".meta", 0) - getValue(a, ".meta", 0);
        }
        if (sortBy === "last_login") {
          const dateA = new Date(a.querySelector(".date")?.textContent || 0);
          const dateB = new Date(b.querySelector(".date")?.textContent || 0);
          return dateB - dateA;
        }
        return 0;
      });

      // –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º DOM
      grid.innerHTML = "";
      cards.forEach(c => grid.appendChild(c));
    }


</script>
  
  async def ws_handler(websocket):
    print("üîå WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω")
    CONNECTED_SOCKETS.add(websocket)
    try:
        async for message in websocket:
            try:
                print("üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç WebSocket:", message)

                data = json.loads(message)
                text = data.get("text", "")
                name = (data.get("name") or "–ê–Ω–æ–Ω–∏–º").strip()
                user_id = data.get("user_id")
                amount = data.get("amount")
                donation_id = data.get("donation_id")
                user = data.get("user")

                # üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
                if not user:
                    await websocket.send("‚ùå –ù–µ —É–∫–∞–∑–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å")
                    continue

                mode = CURRENT_MODE["value"]  # private / public
                profile_key = f"{user}_{mode}"

                if profile_key not in CONFIG.get("profiles", {}):
                    await websocket.send(f"‚ùå –ü—Ä–æ—Ñ–∏–ª—å '{profile_key}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    continue

                # ‚ö†Ô∏è donation_id –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                if not donation_id:
                    print("‚ö†Ô∏è –ù–µ—Ç donation_id ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–µ—Å—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞")

                # üß† –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞
                if "event" in data:
                    event = data["event"]
                    user_id = data.get("user_id")
                    name = data.get("name", "–ê–Ω–æ–Ω–∏–º")
                    text = data.get("text", "")

                    profile = update_vip(profile_key, user_id, name=name, event=event)

                    add_log(
                        profile_key,
                        f"üì• –°–æ–±—ã—Ç–∏–µ: {event.upper()} | {name} ({user_id}) ‚Üí {text}",
                    )

                    # –µ—Å–ª–∏ —ç—Ç–æ –≤—Ö–æ–¥ –∏ –ø—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–∏–ª—Å—è ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç
                    if profile and profile.get("_just_logged_in"):
                        await websocket.send(
                            json.dumps(
                                {
                                    "entry": {
                                        "user_id": user_id,
                                        "name": profile["name"],
                                        "visits": profile["login_count"],
                                        "last_login": profile["_previous_login"],
                                        "total_tips": profile["total"],
                                        "notes": profile["notes"],
                                    }
                                }
                            )
                        )
                        profile["_just_logged_in"] = False  # —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥

                    await websocket.send(f"‚úÖ –°–æ–±—ã—Ç–∏–µ {event} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ")
                    continue

                # üí∏ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã
                if not amount or amount <= 0:
                    await websocket.send("‚ÑπÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–Ω–∞—Ç")
                    continue

                # ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º –¥–æ–Ω–∞—Ç + –¥–µ–π—Å—Ç–≤–∏–µ
                action_text = apply_rule(profile_key, amount, text)

                if action_text:
                    add_log(
                        profile_key, f"‚úÖ [{user}] –î–æ–Ω–∞—Ç | {name} ‚Üí {amount} {action_text}"
                    )
                else:
                    add_log(
                        profile_key, f"‚úÖ [{user}] –î–æ–Ω–∞—Ç | {name} ‚Üí {amount} ‚ÑπÔ∏è –ë–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è"
                    )
                    update_stats(profile_key, "other", amount)

                # üëë –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ VIP‚Äë–ª–∏—Å—Ç–∞
                if user_id:
                    profile = update_vip(profile_key, user_id, name=name, amount=amount)

                    # —Ä–∞—Å—Å—ã–ª–∞–µ–º —Å–æ–±—ã—Ç–∏–µ vip_update –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                    try:
                        msg = json.dumps({
                            "vip_update": True,
                            "user_id": user_id,
                            "profile_key": profile_key
                        })
                        for ws in list(CONNECTED_SOCKETS):
                            try:
                                asyncio.create_task(ws.send(msg))
                            except:
                                CONNECTED_SOCKETS.discard(ws)
                    except Exception as e:
                        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ vip_update (donation): {e}")

                await websocket.send("‚úÖ –î–æ–Ω–∞—Ç –ø—Ä–∏–Ω—è—Ç")

            except Exception as e:
                print("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:", e)
                await websocket.send("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏")

    finally:
        # üîå –£–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
        CONNECTED_SOCKETS.discard(websocket)
        print("üîå WebSocket –æ—Ç–∫–ª—é—á—ë–Ω")
  –ø—Ä–∏–º–µ—Ä –µ—Å–ª–∏ —è –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ 507, —Ç–æ
 —á–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ - (354,9) –Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ–∫–∞–∂–µ—Ç 354,
  –∞ –µ—Å–ª–∏ —è –µ—â–µ + –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ 203, —Ç–æ  
  —á–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ - (354,9 +142,1 = 497,0 ) –∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ–∫–∞–∂–µ—Ç497 11
<script>
  let shownLogs = new Set();
  let shownEntries = new Set();
  let lastLogCount = 0;

  // üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
  const modeSwitch = document.getElementById("modeSwitch");
  modeSwitch.addEventListener("change", () => {
    const newMode = modeSwitch.checked ? "private" : "public";
    fetch("/set_mode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mode: newMode })
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === "ok") {
        showToast(`–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞: ${data.mode === "private" ? "üîí –ß–∞—Å—Ç–Ω—ã–π" : "üåê –ü—É–±–ª–∏—á–Ω—ã–π"}`);
      } else {
        showToast("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞");
      }
    })
    .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º"));
  });

  // üìú –õ–æ–≥–∏ –¥–æ–Ω–∞—Ç–æ–≤
  async function loadLogs() {
    try {
      const res = await fetch("/logs_data");
      const data = await res.json();
      const box = document.getElementById("logbox");
      const logs = data.logs || [];

      const newLogs = logs.slice(lastLogCount);
      lastLogCount = logs.length;

      newLogs.forEach(log => {
        let cssClass = "log-entry";
        if (log.includes("‚Üí")) cssClass += " log-donation";
        if (log.includes("üè∞")) cssClass += " log-vibration";
        if (log.includes("üé¨")) cssClass += " log-action";
        if (log.includes("üì•") || log.toLowerCase().includes("–≤–æ—à—ë–ª")) cssClass += " log-event";

        const div = document.createElement("div");
        div.className = cssClass;
        div.textContent = log;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      });
    } catch (e) {
      console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:", e);
    }
  }

  // üåê WebSocket —Å –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º
  let socket;
  function connectWS() {
    const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws/`;
    socket = new WebSocket(wsUrl);

    socket.onopen = () => {
      console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");
      if (socket._pingInterval) clearInterval(socket._pingInterval);
      socket._pingInterval = setInterval(() => {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: "ping" }));
        }
      }, 30000);
    };

    socket.onclose = () => {
      console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...");
      if (socket._pingInterval) clearInterval(socket._pingInterval);
      setTimeout(connectWS, 2000);
    };

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        const currentUser = "{{ user }}";
        if (data.vibration && data.vibration.target === currentUser) {
          const { strength, duration } = data.vibration;
          startVibrationTimer(duration, strength);
        }
      } catch {
        console.warn("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ WebSocket");
      }
    };
  }
  connectWS();

  // ‚è± –¢–∞–π–º–µ—Ä –≤–∏–±—Ä–∞—Ü–∏–∏
  function startVibrationTimer(duration, strength = "‚Äî") {
    const container = document.getElementById("vibrationTimersContainer");
    const box = document.createElement("div");
    box.className = "vibration-timer";
    box.innerHTML = `
      <div><span class="emoji-bounce">üíñ</span> –í–∏–±—Ä–∞—Ü–∏—è!</div>
      <div>–°–∏–ª–∞: ${strength}</div>
      <div>‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: <span class="time">${Math.ceil(duration)}</span> —Å–µ–∫</div>
      <div class="progress"><div class="progress-bar"></div></div>
    `;
    container.appendChild(box);

    let remaining = duration;
    const timeSpan = box.querySelector(".time");
    const progressBar = box.querySelector(".progress-bar");
    progressBar.style.width = "100%";

    const interval = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        clearInterval(interval);
        box.remove();
      } else {
        timeSpan.textContent = Math.ceil(remaining);
        progressBar.style.width = `${(remaining / duration) * 100}%`;
      }
    }, 1000);
  }

  function formatDate(raw) {
    if (!raw) return "‚Äî";
    const d = new Date(raw);
    return d.toLocaleString("ru-RU", {
      day: "numeric",
      month: "long",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  // üëë –ù–æ–≤—ã–µ –º–µ–º–±–µ—Ä—ã
  async function checkNewEntries() {
    try {
      const res = await fetch("/entries_data");
      const data = await res.json();
      (data.entries || []).forEach(entry => {
        const key = `${entry.user_id}-${entry.last_login}`;
        if (shownEntries.has(key)) return;
        shownEntries.add(key);

        let message = entry.visits
          ? `üëë <strong>${entry.name}</strong><br>
            üìÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∏–∑–∏—Ç: ${formatDate(entry._previous_login || entry.last_login)}<br>
            üî¢ –í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤: ${entry.visits}<br>
            üíó –í—Å–µ–≥–æ —á–∞–µ–≤—ã—Ö: ${entry.total_tips}<br>
            üìù –ó–∞–º–µ—Ç–∫–∏: ${entry.notes || "–Ω–µ—Ç"}`
          : "üÜï –ù–æ–≤—ã–π –º–µ–º–±–µ—Ä!";

        showEntryPopup(message);
      });
    } catch (e) {
      console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ entries:", e);
    }
  }

  // üîÅ –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π
  async function loadQueue() {
    try {
      const res = await fetch("/queue_data");
      const data = await res.json();
      const box = document.getElementById("queuebox");
      if (!data.queue || data.queue.length === 0) {
        box.innerHTML = "<div>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚úÖ</div>";
      } else {
        box.innerHTML = data.queue.map(([strength, duration], i) =>
          `<div>#${i + 1} ‚Üí —Å–∏–ª–∞: ${strength}, –≤—Ä–µ–º—è: ${duration}s</div>`
        ).join("");
      }
    } catch (e) {
      console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏:", e);
    }
  }

  // üßπ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
  document.querySelector("form[action='/clear_logs']").addEventListener("submit", (e) => {
    e.preventDefault();
    lastLogCount = 0;
    document.getElementById("logbox").innerHTML = "";
    fetch("/clear_logs", { method: "POST" })
      .then(() => showToast("–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã ‚úÖ"))
      .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ª–æ–≥–æ–≤"));
  });

  // üßπ –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
  document.getElementById("clearQueueBtn").addEventListener("click", () => {
    fetch("/clear_queue", { method: "POST" })
      .then(r => r.json())
      .then(data => {
        showToast(data.message || "–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞ ‚úÖ");
        loadQueue();
      })
      .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏"));
  });

  // üîî Popup
  function showEntryPopup(message) {
    const popup = document.getElementById("entryPopup");
    popup.innerHTML = `<div>${message}</div><button onclick="hideEntryPopup()">–û–ö</button>`;
    popup.style.display = "block";
    popup.classList.add("show");
    setTimeout(() => {
      popup.classList.remove("show");
      popup.style.display = "none";
    }, 8000);
  }
  function hideEntryPopup() {
    const popup = document.getElementById("entryPopup");
    popup.classList.remove("show");
    popup.style.display = "none";
  }

  // üîî Toast
  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = "toast show";
    setTimeout(() => {
      toast.className = toast.className.replace("show", "");
    }, 3000);
  }

  // ‚è± –¶–∏–∫–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  setInterval(loadLogs, 2000);
  setInterval(checkNewEntries, 2000);
  setInterval(loadQueue, 2000);
  loadLogs();
  checkNewEntries();
  loadQueue();

  // üñ±Ô∏è –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ popup
  let isDragging = false, offsetX = 0, offsetY = 0;
  const popup = document.getElementById("entryPopup");
  popup.addEventListener("mousedown", (e) => {
    isDragging = true;
    offsetX = e.clientX - popup.offsetLeft;
    offsetY = e.clientY -