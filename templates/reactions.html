<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–∞–∫—Ü–∏–∏ ‚Äî {{ profile.uname }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg,#fdfbfb,#ebedee); color:#333; margin:0; padding:40px; }
    header { text-align:center; margin-bottom:20px; }
    header h1 { font-size:28px; font-weight:600; color:#444; margin:0; }
    .obs-link, .reaction-card, .add-rule { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:20px; margin:20px auto; max-width:600px; }
    .reaction-card h3 { margin-top:0; font-size:20px; font-weight:600; color:#444; }
    .reaction-card p { margin:5px 0; color:#555; }
    .preview img { max-width:200px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    button { background:#a3d8f4; border:none; padding:8px 16px; border-radius:20px; color:white; cursor:pointer; transition:0.3s; margin-top:10px; }
    button:hover { background:#74c0e3; }
    .delete { background:#f7a8b8; } 
    .delete:hover { background:#f28497; }
    input { padding:6px; border:1px solid #ddd; border-radius:8px; margin:5px; }
    .back-link { text-align:center; margin-top:30px; }
    .back-link a { background:#f7a8b8; padding:10px 20px; border-radius:20px; color:white; text-decoration:none; font-size:16px; transition:0.3s; }
    .back-link a:hover { background:#f28497; }
  </style>
</head>
<body>
  <header>
    <h1>üé≠ –†–µ–∞–∫—Ü–∏–∏ ‚Äî {{ profile.uname }}</h1>
  </header>

  <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è OBS -->
  <div class="obs-link">
    <p>üîó –°—Å—ã–ª–∫–∞ –¥–ª—è OBS (—Å–∫–æ–ø–∏—Ä—É–π –∏ –≤—Å—Ç–∞–≤—å –≤ –±—Ä–∞—É–∑–µ—Ä‚Äë–∏—Å—Ç–æ—á–Ω–∏–∫):</p>
    <code>https://arinairina.duckdns.org/obs_reactions/{{ user }}/{{ mode }}</code>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª -->
  {% for rule in reactions["rules"] %}
    <div class="reaction-card">
      <h3>–î–∏–∞–ø–∞–∑–æ–Ω: {{ rule.min_points }} ‚Äì {{ rule.max_points }}</h3>
      <p>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ rule.duration }}s</p>
      <div class="preview">
        {% if rule.image %}
          <img src="{{ url_for('static', filename=rule.image) }}" alt="Reaction image">
        {% else %}
          <em>–ù–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏</em>
        {% endif %}
      </div>
      <div class="actions">

        <!-- –¢–µ—Å—Ç -->
        <button type="button" onclick="testReaction('{{ rule.id }}')">üîî –¢–µ—Å—Ç</button>

        <!-- –£–¥–∞–ª–∏—Ç—å -->
        <form method="POST" style="display:inline;">
          <input type="hidden" name="delete_reaction_rule" value="{{ rule.id }}">
          <button type="submit" class="delete">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </form>

        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å -->
        <form method="POST" enctype="multipart/form-data" style="display:inline;">
          <input type="hidden" name="edit_reaction_rule" value="{{ rule.id }}">
          –ú–∏–Ω: <input type="number" name="min_points" value="{{ rule.min_points }}" style="width:60px;">
          –ú–∞–∫—Å: <input type="number" name="max_points" value="{{ rule.max_points }}" style="width:60px;">
          –í—Ä–µ–º—è: <input type="number" name="duration" value="{{ rule.duration }}" style="width:60px;">
          <input type="file" name="image" accept="image/*">
          <button type="submit">‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
        </form>

      </div>
    </div>
  {% endfor %}

  <!-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ -->
  <div class="add-rule">
    <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ</h3>
    <form method="POST" enctype="multipart/form-data">
      –ú–∏–Ω. –ø–æ–∏–Ω—Ç–æ–≤: <input type="number" name="min_points" required>
      –ú–∞–∫—Å. –ø–æ–∏–Ω—Ç–æ–≤: <input type="number" name="max_points" required><br>
      –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫): <input type="number" name="duration" required><br>
      –ö–∞—Ä—Ç–∏–Ω–∫–∞/–≥–∏—Ñ–∫–∞: <input type="file" name="image" accept="image/*"><br>
      <button type="submit" name="add_reaction_rule">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
  <div class="back-link">
    <a href="/">‚¨Ö –ù–∞–∑–∞–¥ –∫ –≥–ª–∞–≤–Ω–æ–π</a>
  </div>

  <script>
    function testReaction(ruleId) {
      fetch("/test_reaction", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({
          rule_id: ruleId,
          profile_key: "{{ profile_key }}"
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          alert("‚úÖ –¢–µ—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ OBS");
        } else {
          alert("‚ùå –û—à–∏–±–∫–∞: " + data.message);
        }
      })
      .catch(() => alert("‚ùå –ó–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è"));
    }
  </script>

</body>
</html>
