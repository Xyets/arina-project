<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>OBS Alert Irina</title>
  <style>
    body {
      margin: 0;
      background: transparent;
      overflow: hidden;
      text-align: center;
      font-family: sans-serif;
      color: #339;
    }
    .vibration-gif {
      width: 200px;
      height: auto;
      display: inline;
      transition: transform 0.3s ease, filter 0.3s ease;
    }
    .vibration-info {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      25% { transform: scale(1.2); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <img src="{{ url_for('static', filename='irina.png') }}" id="gifIrina" class="vibration-gif" />
  <div id="vibrationInfo" class="vibration-info">–û–∂–∏–¥–∞–Ω–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏‚Ä¶</div>

  <script>
    let vibrationQueue = [];
    let isPlaying = false;

    function playNext() {
      if (isPlaying || vibrationQueue.length === 0) return;
      const { strength, duration } = vibrationQueue.shift();
      isPlaying = true;

      const gif = document.getElementById("gifIrina");
      const info = document.getElementById("vibrationInfo");

      if (!gif || !info) { isPlaying = false; playNext(); return; }

      if (isNaN(strength) || strength < 1) strength = 1;
      if (strength > 20) strength = 20;

      // ‚ú® –ß–µ–º –≤—ã—à–µ —Å–∏–ª–∞, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø—É–ª—å—Å
      let speed = 1.5 - (strength * 0.06);
      if (speed < 0.3) speed = 0.3;

      const glowSize = strength * 3;
      const glowOpacity = 0.4 + strength / 25;


      gif.style.animation = `pulse ${speed}s ease-in-out infinite`;
      gif.style.transform = `scale(${1 + strength / 10})`;
      gif.style.filter = `drop-shadow(0 0 ${glowSize}px rgba(30,144,255,${glowOpacity}))`;

      setTimeout(() => {
        gif.style.animation = "";
        gif.style.transform = "scale(1)";
        gif.style.filter = "drop-shadow(0 0 10px rgba(30,144,255,0.5))";
        isPlaying = false;
        playNext();
      }, duration * 1000);
    }

    function enqueueVibration(strength, duration) {
      console.log("üì© –í –æ—á–µ—Ä–µ–¥—å:", strength, duration);
      vibrationQueue.push({ strength, duration });
      playNext();
    }

    // üåê WebSocket —Å –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º –∏ –ø–∏–Ω–≥–∞–º–∏
    let socket;
    function connectWS() {
      const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws/`;
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        socket._pingInterval = setInterval(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "ping" }));
          }
        }, 30000);
      };

      socket.onclose = () => {
        console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...");
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log("üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", data);

          if (data.vibration && data.vibration.target === "Irina") {
            enqueueVibration(data.vibration.strength, data.vibration.duration);
          } else if (data.vip_update) {
            console.log("üîî VIP –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:", data);
          } else {
            console.log("‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:", data);
          }
        } catch (e) {
          console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
        }
      };
    }
    connectWS();
  </script>
</body>
</html>
