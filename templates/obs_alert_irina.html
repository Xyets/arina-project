<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>OBS Alert Irina</title>

  <style>
    body {
      margin: 0;
      background: transparent;
      overflow: hidden;
      text-align: center;
    }

    .vibration-gif {
      width: 200px;
      height: auto;
      display: inline;
      transition: transform 0.3s ease, filter 0.3s ease;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      25% { transform: scale(1.25); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <!-- üî• GIF –ê—Ä–∏–Ω–´ -->
  <img src="{{ url_for('static', filename='irina.png') }}" id="gifIrina" class="vibration-gif" />

  <script>
    /* ---------------------------------------------------------
       üîß 1. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    --------------------------------------------------------- */
    const CURRENT_USER = "Irina";

    /* ---------------------------------------------------------
       üî• 2. –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π
    --------------------------------------------------------- */
    let vibrationQueue = [];
    let isPlaying = false;

    function playNext() {
      if (isPlaying || vibrationQueue.length === 0) return;

      const { strength, duration } = vibrationQueue.shift();
      isPlaying = true;

      const gif = document.getElementById("gifIrina");
      if (!gif) { isPlaying = false; playNext(); return; }

      let s = Math.max(1, Math.min(Number(strength) || 1, 20));

      let speed = Math.max(0.25, 1.5 - s * 0.06);
      const scale = 1 + s / 8;
      const glowSize = s * 4;
      const glowOpacity = 0.5 + s / 20;

      gif.style.animation = `pulse ${speed}s ease-in-out infinite`;
      gif.style.transform = `scale(${scale})`;
      gif.style.filter = `drop-shadow(0 0 ${glowSize}px rgba(30,144,255,${glowOpacity}))`;

      setTimeout(() => {
        gif.style.animation = "";
        gif.style.transform = "scale(1)";
        gif.style.filter = "drop-shadow(0 0 8px rgba(30,144,255,0.4))";

        isPlaying = false;
        playNext();
      }, duration * 1000);
    }

    function enqueueVibration(strength, duration) {
      vibrationQueue.push({ strength, duration });
      playNext();
    }

    /* ---------------------------------------------------------
       üåê 3. WebSocket —Å –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º
    --------------------------------------------------------- */
    let socket;

    function connectWS() {
      const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws/`;
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");

        if (socket._pingInterval) clearInterval(socket._pingInterval);
        socket._pingInterval = setInterval(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "ping" }));
          }
        }, 30000);
      };

      socket.onclose = () => {
        console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch {
          console.warn("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON:", event.data);
          return;
        }

        console.log("üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", data);

        /* ---------------------------------------------------------
           üõë STOP ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–±—Ä–∞—Ü–∏–∏
        --------------------------------------------------------- */
        if (data.stop && data.target.toLowerCase().includes(CURRENT_USER.toLowerCase())) {
          console.log("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–±—Ä–∞—Ü–∏–∏");

          vibrationQueue = [];
          isPlaying = false;

          const gif = document.getElementById("gifIrina");
          gif.style.animation = "";
          gif.style.transform = "scale(1)";
          gif.style.filter = "drop-shadow(0 0 8px rgba(30,144,255,0.4))";

          return;
        }

        /* ---------------------------------------------------------
           üí• –í–∏–±—Ä–∞—Ü–∏—è
        --------------------------------------------------------- */
        if (data.vibration &&
            data.vibration.target.toLowerCase().includes(CURRENT_USER.toLowerCase())) {

          enqueueVibration(data.vibration.strength, data.vibration.duration);
          return;
        }

        /* ---------------------------------------------------------
           üëë VIP –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        --------------------------------------------------------- */
        if (data.vip_update) {
          console.log("üîî VIP –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:", data);
          return;
        }

        console.log("‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:", data);
      };
    }

    connectWS();
  </script>

</body>
</html>
