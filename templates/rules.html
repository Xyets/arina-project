<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–∞–≤–∏–ª–∞</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      color: #333;
      margin: 0;
      padding: 40px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #444;
    }
    .rule-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 20px;
    }
    .rule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .rule-header strong {
      font-size: 16px;
      color: #444;
    }
    .rule-actions button {
      background: #a3d8f4;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      margin-left: 5px;
      cursor: pointer;
      color: white;
      font-size: 14px;
      transition: 0.3s;
    }
    .rule-actions button:hover { background: #74c0e3; }
    .rule-actions .delete { background: #f7a8b8; }
    .rule-actions .delete:hover { background: #f28497; }

    .add-rule {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 20px;
      margin-top: 30px;
    }
    input, select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 5px;
    }
    .add-rule button {
      background: #a3d8f4;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    .add-rule button:hover { background: #74c0e3; }
    a {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: #74c0e3;
    }

    /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      animation: slideDown 0.4s;
    }
    .modal-content h3 { margin-top: 0; }
    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    @keyframes slideDown {
      from {transform: translateY(-50px); opacity: 0;}
      to {transform: translateY(0); opacity: 1;}
    }
    .toast {
      visibility: hidden;
      min-width: 220px;
      margin-left: -110px;
      background-color: #74c0e3;
      color: white;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: fixed;
      z-index: 2000;
      left: 50%;
      bottom: 30px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.5s, bottom 0.5s;
    }
    .toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 50px;
    }
  
  </style>
</head>
<body>
  <h2>üìú –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è {{ session["user"] }}</h2>

  <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
  <div style="text-align:center; margin-bottom:20px;">
    <button type="button" id="testVibrationBtn"
      style="background:#a3d8f4; border:none; padding:10px 20px; border-radius:20px; color:white; cursor:pointer;">
      üîä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∏–±—Ä–∞—Ü–∏—é (default)
    </button>
  </div>

  <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
  <div id="toast" class="toast"></div>

  <script>
  document.getElementById("testVibrationBtn").addEventListener("click", () => {
    fetch("/test_vibration", { method: "POST" })
      .then(r => r.json())
      .then(data => {
        showToast(data.message || "–í–∏–±—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ");
      })
      .catch(() => showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ‚ùå"));
  });

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = "toast show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
  }
  </script>


  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª -->
  {% for rule in rules %}
  <div class="rule-card">
    <div class="rule-header">
      <strong>–î–∏–∞–ø–∞–∑–æ–Ω: {{ rule.min }} ‚Äì {{ rule.max }}</strong>
      <div class="rule-actions">
        <p style="text-align:center;"><a href="/">‚¨Ö –ù–∞–∑–∞–¥</a></p>
        <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ -->
        <button type="button" class="testRuleBtn" data-index="{{ loop.index0 }}">üîä</button>

        <!-- –£–¥–∞–ª–∏—Ç—å -->
        <form method="POST" style="display:inline;">
          <button type="submit" name="delete_rule" value="{{ rule.id }}" class="delete">‚ùå</button>
        </form>
        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å -->
        <button type="button" onclick="openModal('{{ rule.id }}')">‚úèÔ∏è</button>
      </div>
    </div>
    <p>–°–∏–ª–∞: {{ rule.strength }} | –í—Ä–µ–º—è: {{ rule.duration }}s</p>
    <p>–î–µ–π—Å—Ç–≤–∏–µ: {% if rule.action %}üé¨ {{ rule.action }}{% else %}üîä –í–∏–±—Ä–∞—Ü–∏—è{% endif %}</p>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="modal-{{ rule.id }}" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('{{ rule.id }}')">&times;</span>
      <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ</h3>
      <form method="POST">
        <input type="hidden" name="edit_rule" value="{{ rule.id }}">
        –ú–∏–Ω: <input type="number" name="min" value="{{ rule.min }}" required><br>
        –ú–∞–∫—Å: <input type="number" name="max" value="{{ rule.max }}" required><br>
        –°–∏–ª–∞: <input type="number" name="strength" value="{{ rule.strength }}"><br>
        –í—Ä–µ–º—è: <input type="number" name="duration" value="{{ rule.duration }}"><br>
        –¢–∏–ø:
        <select name="action_type">
          <option value="vibration" {% if not rule.action %}selected{% endif %}>–í–∏–±—Ä–∞—Ü–∏—è</option>
          <option value="custom" {% if rule.action %}selected{% endif %}>–î–µ–π—Å—Ç–≤–∏–µ</option>
        </select><br>
        –î–µ–π—Å—Ç–≤–∏–µ: <input type="text" name="action" value="{{ rule.action }}"><br><br>
        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </div>
  </div>
  {% endfor %}

  <!-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ -->
  <div class="add-rule">
    <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ</h3>
    <form method="POST">
      –ú–∏–Ω: <input type="number" name="min" required>
      –ú–∞–∫—Å: <input type="number" name="max" required>
      –°–∏–ª–∞: <input type="number" name="strength">
      –í—Ä–µ–º—è: <input type="number" name="duration">
      –¢–∏–ø:
      <select name="action_type">
        <option value="vibration">–í–∏–±—Ä–∞—Ü–∏—è</option>
        <option value="custom">–î–µ–π—Å—Ç–≤–∏–µ</option>
      </select>
      –î–µ–π—Å—Ç–≤–∏–µ: <input type="text" name="action">
      <button type="submit" name="add_rule">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
  </div>



  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–±—Ä–∞—Ü–∏–∏
    document.getElementById("testVibrationBtn").addEventListener("click", () => {
      fetch("/test_vibration", { method: "POST" })
        .then(r => r.json())
        .then(data => showToast(data.message || "–í–∏–±—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ"))
        .catch(() => showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ ‚ùå"));
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
    document.querySelectorAll(".testRuleBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const ruleIndex = btn.getAttribute("data-index");
        fetch(`/test_rule/${ruleIndex}`, { method: "POST" })
          .then(r => r.json())
          .then(data => showToast(data.message || `–ü—Ä–∞–≤–∏–ª–æ ${ruleIndex} –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚úÖ`))
          .catch(() => showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ ‚ùå"));
      });
    });

    // Toast
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "toast show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    // –ú–æ–¥–∞–ª–∫–∏
    function openModal(id) {
      document.getElementById("modal-" + id).style.display = "block";
    }
    function closeModal(id) {
      document.getElementById("modal-" + id).style.display = "none";
    }
    window.onclick = function(event) {
      document.querySelectorAll('.modal').forEach(m => {
        if (event.target === m) m.style.display = "none";
      });
    }
  </script>

</body>
</html>
