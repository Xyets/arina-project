<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">

    <!-- –®—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #fdfbfb, #ebedee); /* –º—è–≥–∫–∏–π —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
        color: #333;
        margin: 0;
        padding: 40px;
        text-align: center;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 40px;
      }
      header img {
        height: 60px;
      }
      header h1 {
        margin: 0;
        font-size: 30px;
        font-weight: 600;
        color: #444;
      }
      h2 {
        font-weight: 500;
        color: #555;
      }
      .menu {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin: 40px 0;
      }
      .menu a button {
        background: #a3d8f4; /* –Ω–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π */
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 18px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .menu a button:hover {
        background: #74c0e3;
      }
      .box {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin: 20px auto;
        max-width: 700px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        color: #333;
        font-family: monospace;
        text-align: left;
      }
      h3 {
        margin-top: 40px;
        font-weight: 600;
        color: #444;
      }
      form button {
        margin-top: 10px;
        background: #f7a8b8; /* –Ω–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π */
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        cursor: pointer;
        transition: 0.3s;
      }
      form button:hover {
        background: #f28497;
      }

      .toast {
        visibility: hidden;
        min-width: 220px;
        margin-left: -110px;
        background-color: #74c0e3;
        color: white;
        text-align: center;
        border-radius: 8px;
        padding: 12px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        bottom: 30px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.5s, bottom 0.5s;
      }
      .toast.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
      }
      #entryPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        z-index: 9999;
        text-align: center;
        font-size: 18px;
        color: #333;
        max-width: 400px;
      }
      #entryPopup button {
        margin-top: 20px;
        background: #a3d8f4;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      #entryPopup button:hover {
        background: #74c0e3;
      }
      
      .log-entry {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 10px;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        animation: fadeIn 0.3s ease;
      }

      /* –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π */
      .log-donation {
        background: #ffe0f0;
        color: #333;
      }

      .log-login {
        background: #e0f7f1;
        color: #333;
      }

      .log-action {
        background: #e8ecff;
        color: #333;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header>
      <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo">
      <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
    </header>

    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <h2>üëã –ü—Ä–∏–≤–µ—Ç, {{ user }}</h2>
    <p>üîó –ê–¥—Ä–µ—Å WebSocket: <code>wss://arinairina.duckdns.org/ws/</code></p>

    <!-- –ú–µ–Ω—é -->
    <div class="menu">
      <a href="{{ url_for('qrcode_page') }}"><button>üì± QR‚Äë–∫–æ–¥</button></a>
      <a href="{{ url_for('stats_page') }}"><button>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button></a>
      <a href="{{ url_for('rules') }}"><button>‚öôÔ∏è –ü—Ä–∞–≤–∏–ª–∞</button></a>
      <a href="{{ url_for('vip_page') }}"><button>üëë VIP‚Äë–ª–∏—Å—Ç</button></a>
      <a href="{{ url_for('logout') }}"><button>üö™ –í—ã–π—Ç–∏</button></a>
    </div>

    <!-- –õ–æ–≥–∏ -->
    <h3>üìú –õ–æ–≥–∏ –¥–æ–Ω–∞—Ç–æ–≤</h3>
    <div id="logbox" class="box" style="height:300px; overflow-y:scroll;"></div>
    <form method="POST" action="/clear_logs">
        <button type="submit">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </form>

    <!-- –û—á–µ—Ä–µ–¥—å -->
    <h3>üîÅ –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π</h3>
    <div id="queuebox" class="box" style="height:200px; overflow-y:scroll;"></div>
    <div style="text-align:center;">
      <button id="clearQueueBtn"
        style="margin-top:10px; background:#f7a8b8; border:none; padding:10px 20px; border-radius:20px; color:white; cursor:pointer;">
        üßπ –û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
      </button>
    </div>
    <!-- JS -->
    <script>
      async function loadLogs() {
        const res = await fetch("/logs_data");
        const data = await res.json();
        const box = document.getElementById("logbox");
        box.innerHTML = data.logs.map(l => {
          let cssClass = "log-entry";

          if (l.includes("üíó") || l.includes("–ø—Ç")) {
            cssClass += " log-donation";
          } else if (l.includes("–≤–æ—à—ë–ª") || l.includes("üë§")) {
            cssClass += " log-login";
          } else if (l.includes("üé¨") || l.includes("–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª")) {
            cssClass += " log-action";
          }

          return `<div class="${cssClass}">${l}</div>`;
        }).join("");
        box.scrollTop = box.scrollHeight;
      }

      async function loadQueue() {
        const res = await fetch("/queue_data");
        const data = await res.json();
        const box = document.getElementById("queuebox");
        if (data.queue.length === 0) {
          box.innerHTML = "<div>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚úÖ</div>";
        } else {
          box.innerHTML = data.queue.map(([strength, duration], i) => {
            return `<div>#${i + 1} ‚Üí —Å–∏–ª–∞: ${strength}, –≤—Ä–µ–º—è: ${duration}s</div>`;
          }).join("");
        }
      }

      document.getElementById("clearQueueBtn").addEventListener("click", () => {
        fetch("/clear_queue", { method: "POST" })
          .then(r => r.json())
          .then(data => {
            showToast(data.message || "–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞ ‚úÖ");
            loadQueue();
          })
          .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏"));
      });

      
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }
      let shownEntries = new Set();

      async function checkNewEntries() {
      const res = await fetch("/logs_data");
      const data = await res.json();
      const entries = data.entries || [];

      entries.forEach(entry => {
        const key = entry.user_id;
        if (shownEntries.has(key)) return;

        shownEntries.add(key);

        let message = entry.is_new
          ? "üÜï –ù–æ–≤—ã–π –º–µ–º–±–µ—Ä!"
          : `üë§ <strong>${entry.name}</strong><br><small>${entry.notes || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</small>`;

        showEntryPopup(message);
      });
    }

    function showEntryPopup(message) {
      const popup = document.getElementById("entryPopup");
      popup.innerHTML = `
        <div>${message}</div>
        <button onclick="hideEntryPopup()">–û–ö</button>
      `;
      popup.style.display = "block";
    }

    function hideEntryPopup() {
      const popup = document.getElementById("entryPopup");
      popup.style.display = "none";
    }

      setInterval(checkNewEntries, 3000);
      setInterval(loadLogs, 2000);
      setInterval(loadQueue, 2000);
      loadLogs();
      loadQueue();
    </script>
    <div id="toast" class="toast"></div>
    <div id="entryPopup" style="display:none;"></div>
</body>
</html>
