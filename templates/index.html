<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">

    <!-- –®—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #fdfbfb, #ebedee); /* –º—è–≥–∫–∏–π —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
        color: #333;
        margin: 0;
        padding: 40px;
        text-align: center;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 40px;
      }
      header img {
        height: 60px;
      }
      header h1 {
        margin: 0;
        font-size: 30px;
        font-weight: 600;
        color: #444;
      }
      h2 {
        font-weight: 500;
        color: #555;
      }
      .menu {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin: 40px 0;
      }
      .menu a button {
        background: #a3d8f4; /* –Ω–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π */
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 18px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .menu a button:hover {
        background: #74c0e3;
      }
      .box {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin: 20px auto;
        max-width: 700px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        color: #333;
        font-family: monospace;
        text-align: left;
      }
      h3 {
        margin-top: 40px;
        font-weight: 600;
        color: #444;
      }
      form button {
        margin-top: 10px;
        background: #f7a8b8; /* –Ω–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π */
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        cursor: pointer;
        transition: 0.3s;
      }
      form button:hover {
        background: #f28497;
      }

      .toast {
        visibility: hidden;
        min-width: 220px;
        margin-left: -110px;
        background-color: #74c0e3;
        color: white;
        text-align: center;
        border-radius: 8px;
        padding: 12px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        bottom: 30px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.5s, bottom 0.5s;
      }
      .toast.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
      }
      .mode-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
        font-size: 16px;
        font-weight: 500;
        color: #444;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 70px;
        height: 34px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0;
        right: 0; bottom: 0;
        background-color: #a3d8f4;
        transition: .4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px; width: 26px;
        left: 4px; bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #f7a8b8;
      }

      input:checked + .slider:before {
        transform: translateX(36px);
      }

      #entryPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        z-index: 9999;
        text-align: center;
        font-size: 18px;
        color: #333;
        max-width: 400px;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: move;
      }
      #entryPopup.show {
        opacity: 1;
      }
      #entryPopup button {
        margin-top: 20px;
        background: #a3d8f4;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      #entryPopup button:hover {
        background: #74c0e3;
      }
      
      .log-entry {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 10px;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        animation: fadeIn 0.3s ease;
      }

      /* –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π */
      .log-donation {
        background: #ffe0f0;
        color: #333;
      }

      .log-login {
        background: #e0f7f1;
        color: #333;
      }

      .log-action {
        background: #e7d0ec;
        color: #333;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .log-vibration {
        background: #fff4cc; /* –º—è–≥–∫–∏–π –∂—ë–ª—Ç—ã–π */
        color: #333;
      }

      .log-entryevent {
        background: #dceeff; /* –º—è–≥–∫–∏–π –≥–æ–ª—É–±–æ–π */
        color: #333;
      }
      .vibration-timer {
        background: #ffe6f0;
        border-radius: 20px;
        padding: 15px 20px;
        margin-top: 10px;
        font-size: 16px;
        color: #444;
        box-shadow: 0 0 15px rgba(255, 182, 193, 0.6);
        animation: pop 0.3s ease;
        width: 220px;
      }

      .vibration-timer .emoji-bounce {
        display: inline-block;
        animation: bounce 0.6s infinite alternate;
        font-size: 22px;
      }

      @keyframes pop {
        from { transform: scale(0.8); opacity: 0; }
        to   { transform: scale(1); opacity: 1; }
      }

      @keyframes bounce {
        from { transform: translateY(0); }
        to   { transform: translateY(-5px); }
      }

      .progress {
        width: 100%;
        height: 10px;
        background: #fdd;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 8px;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff99cc, #ff66aa);
        transition: width 0.1s linear;
      }

    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header>
      <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo">
      <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
    </header>

    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <h2>üëã –ü—Ä–∏–≤–µ—Ç, {{ user }}</h2>
    
    <div class="mode-toggle">
      <span>üåê –ü—É–±–ª–∏—á–Ω—ã–π</span>
      <label class="switch">
        <input type="checkbox" id="modeSwitch" {% if current_mode == "private" %}checked{% endif %}>
        <span class="slider"></span>
      </label>
      <span>üîí –ß–∞—Å—Ç–Ω—ã–π</span>
    </div>

    <!-- –ú–µ–Ω—é -->
    <div class="menu">
      <a href="{{ url_for('qrcode_page') }}"><button>üì± QR‚Äë–∫–æ–¥</button></a>
      <a href="{{ url_for('stats') }}"><button>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button></a>
      <a href="{{ url_for('rules') }}"><button>‚öôÔ∏è –ü—Ä–∞–≤–∏–ª–∞</button></a>
      <a href="{{ url_for('vip_page') }}"><button>üëë VIP‚Äë–ª–∏—Å—Ç</button></a>
      <a href="{{ url_for('logout') }}"><button>üö™ –í—ã–π—Ç–∏</button></a>
    </div>

    <!-- –õ–æ–≥–∏ -->
    <h3>üìú –õ–æ–≥–∏ –¥–æ–Ω–∞—Ç–æ–≤</h3>
    <div id="logbox" class="box" style="height:300px; overflow-y:scroll;"></div>
    <form method="POST" action="/clear_logs">
        <button type="submit">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </form>

    <!-- –û—á–µ—Ä–µ–¥—å -->
    <h3>üîÅ –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π</h3>
    <div id="queuebox" class="box" style="height:200px; overflow-y:scroll;"></div>
    <div style="text-align:center;">
      <button id="clearQueueBtn"
        style="margin-top:10px; background:#f7a8b8; border:none; padding:10px 20px; border-radius:20px; color:white; cursor:pointer;">
        üßπ –û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
      </button>
    </div>
    <!-- JS -->
    <script>
      let shownLogs = new Set();
      let shownEntries = new Set();
      const modeSwitch = document.getElementById("modeSwitch");
      modeSwitch.addEventListener("change", () => {
        const newMode = modeSwitch.checked ? "private" : "public";
        fetch("/set_mode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode: newMode })
        })
        .then(r => r.json())
        .then(data => {
          if (data.status === "ok") {
            showToast(`–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞: ${data.mode === "private" ? "üîí –ß–∞—Å—Ç–Ω—ã–π" : "üåê –ü—É–±–ª–∏—á–Ω—ã–π"}`);
          } else {
            showToast("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞");
          }
        })
        .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º"));
      });

      // üìú –õ–æ–≥–∏ –¥–æ–Ω–∞—Ç–æ–≤
      async function loadLogs() {
        const res = await fetch("/logs_data");
        const data = await res.json();
        const box = document.getElementById("logbox");

        (data.logs || []).forEach(log => {
          if (shownLogs.has(log)) return;
          shownLogs.add(log);

          let cssClass = "log-entry";

          // üíó –î–æ–Ω–∞—Ç—ã (–ª—é–±–∞—è —Å—Ç—Ä–æ–∫–∞ —Å "‚Üí")
          if (log.includes("‚Üí")) cssClass += " log-donation";

          // üè∞ –í–∏–±—Ä–∞—Ü–∏–∏
          if (log.includes("üè∞")) cssClass += " log-vibration";

          // üé¨ –î–µ–π—Å—Ç–≤–∏—è
          if (log.includes("üé¨")) cssClass += " log-action";

          // üì• –°–æ–±—ã—Ç–∏—è –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞
          if (log.includes("üì•") || log.toLowerCase().includes("–≤–æ—à—ë–ª")) 
              cssClass += " log-entryevent";

          const div = document.createElement("div");
          div.className = cssClass;
          div.textContent = log;
          box.appendChild(div);
          box.scrollTop = box.scrollHeight;
        });
      }

      // üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º
      let socket;

      function connectWS() {
        socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

        socket.onopen = () => {
          console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");

          // üîÑ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π keepalive‚Äë–ø–∏–Ω–≥
          if (socket._pingInterval) clearInterval(socket._pingInterval);
          socket._pingInterval = setInterval(() => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(JSON.stringify({ type: "ping" }));
              console.log("üì§ ping ‚Üí —Å–µ—Ä–≤–µ—Ä—É");
            }
          }, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        };

        socket.onclose = () => {
          console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...");
          if (socket._pingInterval) clearInterval(socket._pingInterval);
          setTimeout(connectWS, 2000);
        };

        socket.onmessage = (event) => {
          let data;
          try {
            data = JSON.parse(event.data);
          } catch {
            return;
          }

          const currentUser = "{{ user }}";

          if (data.vibration && data.vibration.target === currentUser) {
            const { strength, duration } = data.vibration;
            startVibrationTimer(duration, strength);
          }
        };
      }

      // –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      connectWS();


      // ‚è± –¢–∞–π–º–µ—Ä –≤–∏–±—Ä–∞—Ü–∏–∏
      let vibrationInterval;

      function startVibrationTimer(duration, strength = "‚Äî") {
        const container = document.getElementById("vibrationTimersContainer");

        const box = document.createElement("div");
        box.className = "vibration-timer";
        box.innerHTML = `
          <div><span class="emoji-bounce">üíñ</span> –í–∏–±—Ä–∞—Ü–∏—è!</div>
          <div>–°–∏–ª–∞: ${strength}</div>
          <div>‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: <span class="time">${Math.ceil(duration)}</span> —Å–µ–∫</div>
          <div class="progress"><div class="progress-bar"></div></div>
        `;
        container.appendChild(box);

        let remaining = duration;
        const timeSpan = box.querySelector(".time");
        const progressBar = box.querySelector(".progress-bar");

        const interval = setInterval(() => {
          remaining -= 1;
          if (remaining <= 0) {
            clearInterval(interval);
            box.remove();
          } else {
            timeSpan.textContent = Math.ceil(remaining);
            progressBar.style.width = `${(remaining / duration) * 100}%`;
          }
        }, 1000);

        // –Ω–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        progressBar.style.width = "100%";
      }

      function formatDate(raw) {
        if (!raw) return "‚Äî";
        const d = new Date(raw);
        return d.toLocaleString("ru-RU", {
          day: "numeric",
          month: "long",
          hour: "2-digit",
          minute: "2-digit"
        });
      }


      // üëë –ù–æ–≤—ã–µ –º–µ–º–±–µ—Ä—ã
      async function checkNewEntries() {
        const res = await fetch("/entries_data");
        const data = await res.json();

        (data.entries || []).forEach(entry => {
          const key = `${entry.user_id}-${entry.last_login}`;
          if (shownEntries.has(key)) return;
          shownEntries.add(key);

          let message = entry.visits
            ? `üëë <strong>${entry.name}</strong><br>
              üìÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∏–∑–∏—Ç: ${formatDate(entry._previous_login || entry.last_login)}
              üî¢ –í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤: ${entry.visits}<br>
              üíó –í—Å–µ–≥–æ —á–∞–µ–≤—ã—Ö: ${entry.total_tips}<br>
              üìù –ó–∞–º–µ—Ç–∫–∏: ${entry.notes || "–Ω–µ—Ç"}`
            : "üÜï –ù–æ–≤—ã–π –º–µ–º–±–µ—Ä!";

          showEntryPopup(message);
        });
      }

      // üîÅ –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π
      async function loadQueue() {
        const res = await fetch("/queue_data");
        const data = await res.json();
        const box = document.getElementById("queuebox");
        if (data.queue.length === 0) {
          box.innerHTML = "<div>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚úÖ</div>";
        } else {
          box.innerHTML = data.queue.map(([strength, duration], i) =>
            `<div>#${i + 1} ‚Üí —Å–∏–ª–∞: ${strength}, –≤—Ä–µ–º—è: ${duration}s</div>`
          ).join("");
        }
      }

      // üßπ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
      document.querySelector("form[action='/clear_logs']").addEventListener("submit", (e) => {
        e.preventDefault();
        shownLogs.clear();
        document.getElementById("logbox").innerHTML = "";
        fetch("/clear_logs", { method: "POST" })
          .then(() => showToast("–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã ‚úÖ"))
          .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ª–æ–≥–æ–≤"));
      });


      // üßπ –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
      document.getElementById("clearQueueBtn").addEventListener("click", () => {
        fetch("/clear_queue", { method: "POST" })
          .then(r => r.json())
          .then(data => {
            showToast(data.message || "–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞ ‚úÖ");
            loadQueue();
          })
          .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏"));
      });

      // üîî –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      function showEntryPopup(message) {
        const popup = document.getElementById("entryPopup");
        popup.innerHTML = `<div>${message}</div><button onclick="hideEntryPopup()">–û–ö</button>`;
        popup.style.display = "block";
        popup.classList.add("show"); // üëà –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
        setTimeout(() => {
          popup.classList.remove("show"); // üëà –ø–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
          popup.style.display = "none";
        }, 8000);
      }

      function hideEntryPopup() {
        const popup = document.getElementById("entryPopup");
        popup.classList.remove("show");
        popup.style.display = "none";
      }


      // üîî Toast‚Äë—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      // ‚è± –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª—ã
      setInterval(loadLogs, 2000);
      setInterval(checkNewEntries, 3000);
      setInterval(loadQueue, 2000);
      loadLogs();
      checkNewEntries();
      loadQueue();

        // üñ±Ô∏è –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ entryPopup
        let isDragging = false, offsetX = 0, offsetY = 0;
        const popup = document.getElementById("entryPopup");

        popup.addEventListener("mousedown", (e) => {
          isDragging = true;
          offsetX = e.clientX - popup.offsetLeft;
          offsetY = e.clientY - popup.offsetTop;
          popup.style.transition = "none";
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            popup.style.left = `${e.clientX - offsetX}px`;
            popup.style.top = `${e.clientY - offsetY}px`;
            popup.style.transform = "none";
          }
        });

        document.addEventListener("mouseup", () => {
          isDragging = false;
          popup.style.transition = "opacity 0.3s ease";
        });
    </script>
    <div id="vibrationTimersContainer" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>
    <div id="toast" class="toast"></div>
    <div id="entryPopup" style="display:none;"></div>
</body>
</html>