<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">

    <!-- –®—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #fdfbfb, #ebedee); /* –º—è–≥–∫–∏–π —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
        color: #333;
        margin: 0;
        padding: 40px;
        text-align: center;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 40px;
      }
      header img {
        height: 60px;
      }
      header h1 {
        margin: 0;
        font-size: 30px;
        font-weight: 600;
        color: #444;
      }
      h2 {
        font-weight: 500;
        color: #555;
      }
      .menu {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin: 40px 0;
      }
      .menu a button {
        background: #a3d8f4; /* –Ω–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π */
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 18px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .menu a button:hover {
        background: #74c0e3;
      }
      .box {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin: 20px auto;
        max-width: 700px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        color: #333;
        font-family: monospace;
        text-align: left;
      }
      h3 {
        margin-top: 40px;
        font-weight: 600;
        color: #444;
      }
      form button {
        margin-top: 10px;
        background: #f7a8b8; /* –Ω–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π */
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        cursor: pointer;
        transition: 0.3s;
      }
      form button:hover {
        background: #f28497;
      }

      .toast {
        visibility: hidden;
        min-width: 220px;
        margin-left: -110px;
        background-color: #74c0e3;
        color: white;
        text-align: center;
        border-radius: 8px;
        padding: 12px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        bottom: 30px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.5s, bottom 0.5s;
      }
      .toast.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
      }
      .mode-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
        font-size: 16px;
        font-weight: 500;
        color: #444;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 70px;
        height: 34px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0;
        right: 0; bottom: 0;
        background-color: #a3d8f4;
        transition: .4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px; width: 26px;
        left: 4px; bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #f7a8b8;
      }

      input:checked + .slider:before {
        transform: translateX(36px);
      }

      #entryPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        z-index: 9999;
        text-align: center;
        font-size: 18px;
        color: #333;
        max-width: 400px;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: move;
      }
      #entryPopup.show {
        opacity: 1;
      }
      #entryPopup button {
        margin-top: 20px;
        background: #a3d8f4;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      #entryPopup button:hover {
        background: #74c0e3;
      }
      
      .log-entry {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 10px;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        animation: fadeIn 0.3s ease;
      }

      /* –í–∏–±—Ä–∞—Ü–∏–∏ */
      .log-vibration {
        background: #fff4ce; /* –º—è–≥–∫–∏–π –∂—ë–ª—Ç—ã–π */
        color: #333;
      }

      /* –î–µ–π—Å—Ç–≤–∏—è */
      .log-action {
        background: #ffdce3; /* –Ω–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π */
        color: #333;
      }

      /* LOGIN / LOGOUT */
      .log-loginout {
        background: #d4f0ff; /* –ø–∞—Å—Ç–µ–ª—å–Ω–æ-–≥–æ–ª—É–±–æ–π */
        color: #333;
      }

      /* –î–æ–Ω–∞—Ç –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è */
      .log-donation-plain {
        background: #d5ffdc; /* —Å–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω—ã–π */
        color: #333;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .log-vibration {
        background: #fff4cc; /* –º—è–≥–∫–∏–π –∂—ë–ª—Ç—ã–π */
        color: #333;
      }

      .log-entryevent {
        background: #dceeff; /* –º—è–≥–∫–∏–π –≥–æ–ª—É–±–æ–π */
        color: #333;
      }
      .vibration-timer {
        background: #ffe6f0;
        border-radius: 20px;
        padding: 15px 20px;
        margin-top: 10px;
        font-size: 16px;
        color: #444;
        box-shadow: 0 0 15px rgba(255, 182, 193, 0.6);
        animation: pop 0.3s ease;
        width: 220px;
      }

      .vibration-timer .emoji-bounce {
        display: inline-block;
        animation: bounce 0.6s infinite alternate;
        font-size: 22px;
      }

      @keyframes pop {
        from { transform: scale(0.8); opacity: 0; }
        to   { transform: scale(1); opacity: 1; }
      }

      @keyframes bounce {
        from { transform: translateY(0); }
        to   { transform: translateY(-5px); }
      }

      .progress {
        width: 100%;
        height: 10px;
        background: #fdd;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 8px;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff99cc, #ff66aa);
        transition: width 0.1s linear;
      }
      .goal-card {
        background:#fff;
        padding:20px;
        border-radius:16px;
        box-shadow:0 6px 18px rgba(0,0,0,0.1);
        max-width:600px;
        margin:20px auto;
        text-align:center;
      }

      .goal-bar {
        width:100%;
        height:25px;
        background:#eee;
        border-radius:12px;
        overflow:hidden;
        margin:15px 0;
      }

      #goalFill {
        height:100%;
        width:0%;
        background:linear-gradient(90deg,#74c0e3,#a3d8f4);
        transition:0.4s;
      }

      .new-goal-btn {
        background:#a3d8f4;
        color:white;
        padding:10px 20px;
        border:none;
        border-radius:12px;
        cursor:pointer;
      }
      .modal {
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.5);
        z-index:9998;
      }

      .modal-content {
        background:#fff;
        padding:20px;
        border-radius:12px;
        width:300px;
        margin:150px auto;
        box-shadow:0 6px 18px rgba(0,0,0,0.2);
        text-align:center;
      }


    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header>
      <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo">
      <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
    </header>

    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <h2>üëã –ü—Ä–∏–≤–µ—Ç, {{ user }}</h2>
    <div class="mode-toggle">
      <span>üåê –ü—É–±–ª–∏—á–Ω—ã–π</span>
      <label class="switch">
        <input type="checkbox" id="modeSwitch" {% if current_mode == "private" %}checked{% endif %}>
        <span class="slider"></span>
      </label>
      <span>üîí –ß–∞—Å—Ç–Ω—ã–π</span>
    </div>

    <!-- –ú–µ–Ω—é -->
    <div class="menu">
      <a href="{{ url_for('lovense.qrcode_page', profile_key=current_profile) }}">
          <button>üì± QR‚Äë–∫–æ–¥</button>
      </a>

      <a href="{{ url_for('stats.stats_page') }}">
          <button>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </a>

      <a href="{{ url_for('rules.rules_page') }}">
          <button>‚öôÔ∏è –ü—Ä–∞–≤–∏–ª–∞</button>
      </a>

      <a href="{{ url_for('reactions.reactions_page') }}">
          <button>üé≠ –†–µ–∞–∫—Ü–∏–∏</button>
      </a>

      <a href="{{ url_for('vip.vip_page') }}">
          <button>üëë VIP‚Äë–ª–∏—Å—Ç</button>
      </a>

      <a href="{{ url_for('panel.logout') }}">
          <button>üö™ –í—ã–π—Ç–∏</button>
      </a>

    </div>

    {% if current_mode == "public" %}
    <div class="goal-card">
      <h3>üéØ {{ goal.title or "–¶–µ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞" }}</h3>

      <div class="goal-bar">
        <div id="goalFill"></div>
      </div>

      <div class="goal-text">
        <span id="goalCurrent">{{ goal.current }}</span> /
        <span id="goalTarget">{{ goal.target }}</span>
      </div>

      <button class="new-goal-btn" onclick="openGoalModal()">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å</button>
    </div>
    {% endif %}

    <!-- –õ–æ–≥–∏ -->
    <h3>üìú –õ–æ–≥–∏ –¥–æ–Ω–∞—Ç–æ–≤</h3>
    <div id="logbox" class="box" style="height:300px; overflow-y:scroll;"></div>
    <form method="POST" action="/clear_logs">
        <button type="submit">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </form>

    <!-- –û—á–µ—Ä–µ–¥—å -->
    <h3>üîÅ –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π</h3>
    <div id="queuebox" class="box" style="height:200px; overflow-y:scroll;"></div>
    <div style="text-align:center;">
      <button id="clearQueueBtn"
        style="margin-top:10px; background:#f7a8b8; border:none; padding:10px 20px; border-radius:20px; color:white; cursor:pointer;">
        üßπ –û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
      </button>
    </div>
    <!-- JS -->
    <script>

      /* ---------------------------------------------------------
        üîß 1. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      --------------------------------------------------------- */
      const CURRENT_USER = "{{ user }}";
      let lastLogCount = 0;
      const shownEntries = new Set();


      /* ---------------------------------------------------------
        üåê WebSocket ‚Äî –û–î–ù–û –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –±–µ–∑ –∞–≤—Ç–æ‚Äë–¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      --------------------------------------------------------- */
      let socket = null;

      function connectWS() {
          // üîí –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ
          if (socket && socket.readyState === WebSocket.OPEN) {
              console.log("‚ö†Ô∏è WebSocket —É–∂–µ –æ—Ç–∫—Ä—ã—Ç ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞—ë–º");
              return;
          }

          const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws`;
          socket = new WebSocket(wsUrl);

          socket.onopen = () => {
              console.log("‚úÖ –ü–∞–Ω–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ WebSocket");

              const mode = document.getElementById("modeSwitch").checked ? "private" : "public";
              const profile_key = `${CURRENT_USER}_${mode}`;

              socket.send(JSON.stringify({
                  type: "hello",
                  role: "panel",
                  profile_key: profile_key
              }));

              // –ü–∏–Ω–≥
              if (socket._pingInterval) clearInterval(socket._pingInterval);
              socket._pingInterval = setInterval(() => {
                  if (socket.readyState === WebSocket.OPEN) {
                      socket.send(JSON.stringify({ type: "ping" }));
                  }
              }, 30000);
          };


          socket.onclose = () => {
              console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç");

              if (socket._pingInterval) clearInterval(socket._pingInterval);

              // üî• –£–º–Ω—ã–π –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç
              setTimeout(() => {
                  if (!socket || socket.readyState === WebSocket.CLOSED) {
                      console.log("üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket...");
                      connectWS();
                  }
              }, 2000);
          };


          socket.onmessage = (event) => {
              let data;
              try { data = JSON.parse(event.data); }
              catch { return; }

              console.log("üì° –ü–∞–Ω–µ–ª—å –ø–æ–ª—É—á–∏–ª–∞:", data);

              if (data.type === "refresh_logs") {
                  loadLogs();
                  return;
              }
              // ---------- HELLO_OK ----------
              if (data.status === "hello_ok" && data.role === "panel") {
                  const mode = document.getElementById("modeSwitch").checked ? "private" : "public";
                  const profile_key = `${CURRENT_USER}_${mode}`;

                  console.log("üì• HELLO_OK ‚Äî –ó–ê–ü–†–ê–®–ò–í–ê–Æ –û–ß–ï–†–ï–î–¨");
                  socket.send(JSON.stringify({
                      type: "get_queue",
                      profile_key: profile_key
                  }));
                  return;
              }

              // ---------- –í–ò–ë–†–ê–¶–ò–Ø ----------
              if (data.vibration) {
                  const v = data.vibration;

                  startVibrationTimer(v.duration, v.strength);
                  return;
              }
              // ---------- –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–ß–ï–†–ï–î–ò –í–ò–ë–†–ê–¶–ò–ô ----------
              if (data.queue_update) {
                  const q = data.queue || [];
                  vibrationQueue = q.map(v => ({
                      strength: v[0],
                      duration: v[1]
                  }));
                  updateQueueUI();
                  return;
              }

              // ---------- POPUP ENTRY ----------
              if (data.entry) {
                  const e = data.entry;
                  const message = `
                      üë§ <strong>${e.name}</strong><br>
                      üî¢ –í–∏–∑–∏—Ç–æ–≤: ${e.visits}<br>
                      üíó –ß–∞–µ–≤—ã—Ö –≤—Å–µ–≥–æ: ${e.total_tips}<br>
                      üìù –ó–∞–º–µ—Ç–∫–∏: ${e.notes || "–Ω–µ—Ç"}
                  `;
                  showEntryPopup(message);
                  return;
              }

              // ---------- GOAL UPDATE ----------
              if (data.goal_update) {
                  updateGoalUI(data.goal);
                  return;
              }

              // ---------- VIP UPDATE ----------
              if (data.vip_update) return;

              // ---------- MODE UPDATE ----------
              if (data.mode_update && data.user === CURRENT_USER) {
                  location.reload();
                  return;
              }
          };
      }

      connectWS();

      document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
              if (!socket || socket.readyState !== WebSocket.OPEN) {
                  console.log("üîÑ –í–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket");
                  connectWS();
              }
          }
      });



      /* ---------------------------------------------------------
        üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
      --------------------------------------------------------- */
      const modeSwitch = document.getElementById("modeSwitch");

      modeSwitch.addEventListener("change", () => {
          const newMode = modeSwitch.checked ? "private" : "public";

          // üî• –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É WebSocket-—Å–µ—Ä–≤–µ—Ä—É
          socket.send(JSON.stringify({
              type: "set_mode",
              user: CURRENT_USER,
              mode: newMode
          }));

          // üî• –°–æ–æ–±—â–∞–µ–º Flask (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏)
          fetch("/set_mode", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ mode: newMode })
          })
          .then(r => r.json())
          .then(data => {
              if (data.status === "ok") {
                  showToast(`–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞: ${data.mode === "private" ? "üîí –ß–∞—Å—Ç–Ω—ã–π" : "üåê –ü—É–±–ª–∏—á–Ω—ã–π"}`);
                  // üåü –ó–ê–ì–†–£–ñ–ê–ï–ú –¶–ï–õ–¨ –î–õ–Ø –ù–û–í–û–ì–û –†–ï–ñ–ò–ú–ê 
                  fetch("/goal_data") 
                    .then(r => r.json()) 
                    .then(g => { 
                      goal = g; // –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ü–µ–ª—å 
                      updateGoalUI();
                    });
              } else {
                  showToast("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞");
              }
          })
          .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º"));
      });

      /* ---------------------------------------------------------
        üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–±—Ä–∞—Ü–∏–∏
      --------------------------------------------------------- */
      function sendStop() {
          const mode = document.getElementById("modeSwitch").checked ? "private" : "public";
          const profile_key = `${CURRENT_USER}_${mode}`;

          socket.send(JSON.stringify({
              type: "stop",
              user: CURRENT_USER,
              profile_key: profile_key
          }));

          console.log("‚õî STOP SENT:", profile_key);
      }



      // üìú –õ–æ–≥–∏ –¥–æ–Ω–∞—Ç–æ–≤
      async function loadLogs() {
          try {
              const res = await fetch("/logs_data");
              const data = await res.json();
              const box = document.getElementById("logbox");
              const logs = data.logs || [];

              const newLogs = logs.slice(lastLogCount);
              lastLogCount = logs.length;

              newLogs.forEach(log => {
                  let cssClass = "log-entry";
                  if (log.includes("üè∞")) cssClass += " log-vibration";
                  else if (log.includes("üé¨")) cssClass += " log-action";
                  else if (log.includes("LOGIN") || log.includes("LOGOUT") || log.includes("üîµ")) cssClass += " log-loginout";
                  else if (log.includes("üçÄ")) cssClass += " log-donation-plain";

                  const div = document.createElement("div");
                  div.className = cssClass;
                  div.textContent = log;
                  box.appendChild(div);
                  box.scrollTop = box.scrollHeight;
              });
          } catch (e) {
              console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:", e);
          }
      }


      // ‚è± –¢–∞–π–º–µ—Ä –≤–∏–±—Ä–∞—Ü–∏–∏
      function startVibrationTimer(duration, strength = "‚Äî") {
          const container = document.getElementById("vibrationTimersContainer");
          const box = document.createElement("div");
          box.className = "vibration-timer";
          box.innerHTML = `
            <div><span class="emoji-bounce">üíñ</span> –í–∏–±—Ä–∞—Ü–∏—è!</div>
            <div>–°–∏–ª–∞: ${strength}</div>
            <div>‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: <span class="time">${Math.ceil(duration)}</span> —Å–µ–∫</div>
            <div class="progress"><div class="progress-bar"></div></div>
            <button class="stop-vibration-btn"
                    style="margin-top:8px; background:#ff4d4d; border:none; padding:6px 12px; border-radius:12px; color:white; cursor:pointer; font-size:12px;">
              ‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>
          `;
          container.appendChild(box);

          let remaining = duration;
          const timeSpan = box.querySelector(".time");
          const progressBar = box.querySelector(".progress-bar");
          const stopBtn = box.querySelector(".stop-vibration-btn");
          progressBar.style.width = "100%";

          const interval = setInterval(() => {
              remaining -= 1;
              if (remaining <= 0) { 
                clearInterval(interval); 
                box.remove(); 
                

              } else {
                  timeSpan.textContent = Math.ceil(remaining);
                  progressBar.style.width = `${(remaining / duration) * 100}%`;
              }
          }, 1000);

          // ‚õî –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–±—Ä–∞—Ü–∏–∏ ‚Äî –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ WebSocket
          stopBtn.addEventListener("click", () => {
              sendStop();
              clearInterval(interval);
              box.remove();
              if (typeof showToast === "function") showToast("–í–∏–±—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
          });
      }


      function formatDate(raw) {
          if (!raw) return "‚Äî";
          const d = new Date(raw);
          return d.toLocaleString("ru-RU", {
              day: "numeric",
              month: "long",
              hour: "2-digit",
              minute: "2-digit"
          });
      }


      // üëë –ù–æ–≤—ã–µ –º–µ–º–±–µ—Ä—ã
      async function checkNewEntries() {
          try {
              const res = await fetch("/entries_data");
              const data = await res.json();
              (data.entries || []).forEach(entry => {
                  const key = `${entry.user_id}-${entry.last_login}`;
                  if (shownEntries.has(key)) return;
                  shownEntries.add(key);

                  let message = entry.visits
                    ? `üëë <strong>${entry.name}</strong><br>
                      üìÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∏–∑–∏—Ç: ${formatDate(entry._previous_login || entry.last_login)}<br>
                      üî¢ –í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤: ${entry.visits}<br>
                      üíó –í—Å–µ–≥–æ —á–∞–µ–≤—ã—Ö: ${entry.total_tips}<br>
                      üìù –ó–∞–º–µ—Ç–∫–∏: ${entry.notes || "–Ω–µ—Ç"}`
                    : "üÜï –ù–æ–≤—ã–π –º–µ–º–±–µ—Ä!";

                  showEntryPopup(message);
              });
          } catch (e) {
              console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ entries:", e);
          }
      }

      // üßπ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
      document.querySelector("form[action='/clear_logs']").addEventListener("submit", (e) => {
          e.preventDefault();
          lastLogCount = 0;
          document.getElementById("logbox").innerHTML = "";
          fetch("/clear_logs", { method: "POST" })
            .then(() => showToast("–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã ‚úÖ"))
            .catch(() => showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ª–æ–≥–æ–≤"));
      });


      // üîÅ –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π
      let vibrationQueue = [];

      // üßπ –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
      document.getElementById("clearQueueBtn").addEventListener("click", () => {
          const mode = document.getElementById("modeSwitch").checked ? "private" : "public";
          const profile_key = `${CURRENT_USER}_${mode}`;

          // –æ—á–∏—â–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          socket.send(JSON.stringify({
              type: "clear_queue",
              profile_key: profile_key
          }));

          // –ª–æ–∫–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É —á–∏—Å—Ç–∏–º
          showToast("–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞ ‚úÖ");
      });

      function updateQueueUI() {
          const box = document.getElementById("queuebox");
          if (!box) return;

          if (!vibrationQueue || vibrationQueue.length === 0) {
              box.innerHTML = `<div style="color:#aaa; text-align:center;">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚úÖ</div>`;
              return;
          }

          box.innerHTML = vibrationQueue
              .map((v, i) => `<div>#${i + 1} ‚Üí —Å–∏–ª–∞: ${v.strength}, –≤—Ä–µ–º—è: ${v.duration}s</div>`)
              .join("");

          box.scrollTop = box.scrollHeight;
      }





      // üîî Popup
      function showEntryPopup(message) {
          const popup = document.getElementById("entryPopup");
          popup.innerHTML = `<div>${message}</div><button onclick="hideEntryPopup()">–û–ö</button>`;
          popup.style.display = "block";
          popup.classList.add("show");
          let hideTimer = setTimeout(hidePopup, 8000);

          popup.addEventListener("mouseenter", () => clearTimeout(hideTimer));
          popup.addEventListener("mouseleave", () => hideTimer = setTimeout(hidePopup, 8000));

          function hidePopup() {
              popup.classList.remove("show");
              popup.style.display = "none";
          }
      }

      function hideEntryPopup() {
          const popup = document.getElementById("entryPopup");
          popup.classList.remove("show");
          popup.style.display = "none";
      }


      // üîî Toast
      function showToast(message) {
          const toast = document.getElementById("toast");
          toast.textContent = message;
          toast.className = "toast show";
          setTimeout(() => {
            toast.className = toast.className.replace("show", "");
          }, 3000);
      }

      setInterval(loadLogs, 2000); 
      loadLogs();

      window.addEventListener("beforeunload", () => {
          if (socket && socket.readyState === WebSocket.OPEN) {
              socket.close(1000, "page unload");
          }
      });

    </script>

    <script>

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–ª—å, –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é Flask
        let goal = { title: "", target: 0, current: 0 };


        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ü–µ–ª–∏
        function updateGoalUI(newGoal = null) {
            if (newGoal) goal = newGoal;

            const fill = document.getElementById("goalFill");
            const cur = document.getElementById("goalCurrent");
            const tgt = document.getElementById("goalTarget");

            // –ï—Å–ª–∏ —Ü–µ–ª—å —Å–∫—Ä—ã—Ç–∞ (—Ä–µ–∂–∏–º private) ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
            if (!fill || !cur || !tgt) return;

            const percent = goal.target > 0 ? (goal.current / goal.target) * 100 : 0;

            fill.style.width = Math.min(percent, 100) + "%";
            cur.textContent = goal.current;
            tgt.textContent = goal.target;
        }


        fetch("/goal_data") 
          .then(r => r.json()) 
          .then(g => { 
            goal = g; 
            updateGoalUI(); 
          }); // –ø–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    </script>

    <div id="vibrationTimersContainer" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>
    <div id="toast" class="toast"></div>
    <div id="entryPopup" style="display:none;"></div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ü–µ–ª–∏ -->
    <div id="goalModal" class="modal">
      <div class="modal-content">
        <h3>–ù–æ–≤–∞—è —Ü–µ–ª—å</h3>
        <form id="goalForm">
          <input name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏">
          <input name="target" placeholder="–°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ" type="number">
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </div>

    <script>
    function openGoalModal() {
      document.getElementById("goalModal").style.display = "block";
    }

    document.getElementById("goalForm").onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      await fetch("/goal_new", { method:"POST", body:formData });

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      document.getElementById("goalModal").style.display = "none";

      // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å WebSocket
      goal.current = 0;
      goal.title = formData.get("title");
      goal.target = Number(formData.get("target"));
      updateGoalUI();
    };
    </script>
  </body>
</html>