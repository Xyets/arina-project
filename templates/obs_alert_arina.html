<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>OBS Alert Arina</title>

  <style>
    body {
      margin: 0;
      background: transparent;
      overflow: hidden;
      text-align: center;
    }

    .vibration-gif {
      width: 200px;
      height: auto;
      display: inline;
      transition: transform 0.3s ease, filter 0.3s ease;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      25% { transform: scale(1.25); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <!-- üî• GIF –ê—Ä–∏–Ω–´ -->
  <img src="{{ url_for('static', filename='arina.png') }}" id="gifArina" class="vibration-gif" />

  <script>
    /* ---------------------------------------------------------
       üîß 1. –ü—Ä–æ—Ñ–∏–ª—å OBS (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º)
    --------------------------------------------------------- */
    const PROFILE_KEY = "{{ profile_key }}";

    /* ---------------------------------------------------------
       üî• 2. –û—á–µ—Ä–µ–¥—å –≤–∏–±—Ä–∞—Ü–∏–π
    --------------------------------------------------------- */
    let vibrationQueue = [];
    let isPlaying = false;

    function playNext() {
      if (isPlaying || vibrationQueue.length === 0) return;

      const { strength, duration } = vibrationQueue.shift();
      isPlaying = true;

      const gif = document.getElementById("gifArina");
      if (!gif) { isPlaying = false; playNext(); return; }

      let s = Math.max(1, Math.min(Number(strength) || 1, 20));

      let speed = Math.max(0.25, 1.5 - s * 0.06);
      const scale = 1 + s / 8;
      const glowSize = s * 4;
      const glowOpacity = 0.5 + s / 20;

      gif.style.animation = `pulse ${speed}s ease-in-out infinite`;
      gif.style.transform = `scale(${scale})`;
      gif.style.filter = `drop-shadow(0 0 ${glowSize}px rgba(30,144,255,${glowOpacity}))`;

      setTimeout(() => {
        gif.style.animation = "";
        gif.style.transform = "scale(1)";
        gif.style.filter = "drop-shadow(0 0 8px rgba(30,144,255,0.4))";

        isPlaying = false;
        playNext();
      }, duration * 1000);
    }

    function enqueueVibration(strength, duration) {
      vibrationQueue.push({ strength, duration });
      playNext();
    }

    /* ---------------------------------------------------------
       üåê 3. WebSocket —Å –∞–≤—Ç–æ‚Äë—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º
    --------------------------------------------------------- */
    let socket = null;

    function connectWS() {
      socket = new WebSocket(`ws://${location.hostname}:8765/`);

      socket.onopen = () => {
        console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");

        // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è OBS
        socket.send(JSON.stringify({
          type: "hello",
          role: "obs",
          profile_key: PROFILE_KEY
        }));

        // PING
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        socket._pingInterval = setInterval(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "ping" }));
          }
        }, 30000);
      };

      socket.onclose = () => {
        console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch {
          console.warn("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON:", event.data);
          return;
        }

        console.log("üì° –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", data);

        /* ---------------------------------------------------------
           üõë STOP ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–±—Ä–∞—Ü–∏–∏
        --------------------------------------------------------- */
        if (data.stop && data.target === PROFILE_KEY) {
          console.log("üõë STOP –ø–æ–ª—É—á–µ–Ω");

          vibrationQueue = [];
          isPlaying = false;

          const gif = document.getElementById("gifArina");
          gif.style.animation = "";
          gif.style.transform = "scale(1)";
          gif.style.filter = "drop-shadow(0 0 8px rgba(30,144,255,0.4))";

          return;
        }

        /* ---------------------------------------------------------
           üí• –í–∏–±—Ä–∞—Ü–∏—è
        --------------------------------------------------------- */
        if (data.vibration && data.vibration.target === PROFILE_KEY) {
          enqueueVibration(data.vibration.strength, data.vibration.duration);
          return;
        }

        /* ---------------------------------------------------------
           üé≠ –†–µ–∞–∫—Ü–∏–∏ OBS
        --------------------------------------------------------- */
        if (data.reaction && data.profile === PROFILE_KEY) {
          console.log("üé≠ –†–µ–∞–∫—Ü–∏—è:", data);
          // –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏
          return;
        }
      };
    }

    connectWS();
  </script>

</body>
</html>
