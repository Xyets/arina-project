<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VIP‚Äë–ª–∏—Å—Ç</title>
  <link rel="icon" href="{{ url_for('static', filename='icon.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      margin: 0;
      padding: 40px;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    header img { height: 60px; }
    header h1 { font-size: 28px; font-weight: 600; margin: 0; }
    .top-bar {
      display: flex; justify-content: space-between; flex-wrap: wrap;
      gap: 20px; margin-bottom: 30px;
    }
    .search-bar input {
      padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc;
      width: 250px; font-size: 16px;
    }
    .search-bar button {
      padding: 10px 20px; border-radius: 20px; border: none;
      background: #a3d8f4; color: white; font-size: 16px; cursor: pointer;
    }
    .card-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .vip-card {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;
    }
    .vip-card.blocked { background: #ffe0e0; }
    .vip-card h3 { margin: 0 0 10px; font-size: 20px; color: #444; }
    .vip-card input[type="text"] {
      width: 100%; padding: 6px; margin-bottom: 8px;
      border-radius: 6px; border: 1px solid #ccc; font-family: monospace;
    }
    .vip-card .meta { font-size: 14px; color: #666; margin-bottom: 10px; }
    .vip-card .actions { display: flex; justify-content: space-between; gap: 8px; }
    .vip-card button {
      background: #f7a8b8; border: none; padding: 6px 12px;
      border-radius: 12px; color: white; cursor: pointer; font-size: 14px;
    }
    .vip-card button:hover { background: #f28497; }
    .sort-links a {
      margin-right: 10px; font-size: 14px; color: #888; text-decoration: none;
    }
    .sort-links a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo">
    <h1>VIP‚Äë–ª–∏—Å—Ç –¥–ª—è {{ user }}</h1>
    <p style="text-align:center;"><a href="/">‚¨Ö –ù–∞–∑–∞–¥</a></p>
  </header>

  <div class="top-bar">
    <form method="GET" action="/vip" class="search-bar">
      <input type="text" name="q" placeholder="üîç –ü–æ–∏—Å–∫..." value="{{ query }}">
      <button type="submit">–ù–∞–π—Ç–∏</button>
      {% if query %}<a href="/vip">–°–±—Ä–æ—Å–∏—Ç—å</a>{% endif %}
    </form>

    <div class="sort-links">
      <a href="/vip?sort=total">üíó –ü–æ —á–∞–µ–≤—ã–º</a>
      <a href="/vip?sort=login_count">üìÖ –ü–æ –≤–∏–∑–∏—Ç–∞–º</a>
      <a href="/vip?sort=last_login">üïí –ü–æ –¥–∞—Ç–µ</a>
    </div>

  </div>

  <div class="card-grid">
    {% for user_id, info in members %}
    <div class="vip-card {% if info.blocked %}blocked{% endif %}" id="card_{{ user_id }}">
      <form method="POST">
        <input type="hidden" name="user_id" value="{{ user_id }}">
        <input type="hidden" name="sort" value="{{ request.args.get('sort', 'total') }}">
        <input type="hidden" name="q" value="{{ query }}">
  
        <h3><input type="text" name="name" value="{{ info.name }}"></h3>
        <input type="text" name="notes" value="{{ info.notes }}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
        <div class="meta">
          üíó {{ info.total }} | üìÖ {{ info.login_count }} –≤—Ö–æ–¥–æ–≤<br>
          üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: <span class="date">{{ info.last_login }}</span><br>
          üÜî ID: <code>{{ user_id }}</code>
        </div>
        <div class="actions">
          <button type="submit">üíæ</button>
          <button type="button" onclick="openDeleteModal('{{ user_id }}')">üóëÔ∏è</button>
        </div>
      </form>
    </div>
    {% endfor %}
  </div>

  <script>
    // —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –±–µ—Ä—ë–º –∏–∑ URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    let currentSort = new URL(window.location.href).searchParams.get("sort") || "total";

    // AJAX‚Äë—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    async function saveMember(form) {
      const formData = new FormData(form);

      try {
        const res = await fetch("/vip", {
          method: "POST",
          body: formData
        });

        if (res.ok) {
          console.log("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");

          // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–Ω–æ–≤–æ –∏–∑ /vip_data
          const userId = form.querySelector("input[name='user_id']").value;
          await refreshVipCard(userId);

          // –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          resortCards(currentSort);
        } else {
          alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ AJAX‚Äë—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      }
    }

    function removeMember(userId) {
      fetch("/remove_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.remove();
          // –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º
          resortCards(currentSort);
        } else {
          alert("‚ùå " + data.message);
        }
      })
      .catch(() => alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"));
    }


    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è —É–∂–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    document.querySelectorAll(".date").forEach(el => {
      const raw = el.textContent.trim();
      if (!raw) return;
      const iso = raw.replace(" ", "T");
      const d = new Date(iso);
      if (!isNaN(d.getTime())) {
        el.textContent = d.toLocaleString("ru-RU", {
          day: "numeric",
          month: "long",
          hour: "2-digit",
          minute: "2-digit"
        });
      }
    });

    // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    let socket;
    function connectWS() {
      socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

      socket.onopen = () => console.log("‚úÖ WS –æ—Ç–∫—Ä—ã—Ç");
      socket.onclose = () => {
        console.log("‚ùå WS –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.vip_update && data.user_id) {
          console.log("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É:", data.user_id);
          refreshVipCard(data.user_id); // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–∑–æ–≤–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        }
      };
    }
    connectWS();

    // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞
    async function refreshVipList() {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const grid = document.querySelector(".card-grid");
        grid.innerHTML = "";

        Object.entries(data.members || {}).forEach(([user_id, info]) => {
          const card = document.createElement("div");
          card.className = "vip-card" + (info.blocked ? " blocked" : "");
          card.id = "card_" + user_id;

          const rawDate = info.last_login || "";
          const d = rawDate ? new Date(rawDate.replace(" ", "T")) : null;
          const formattedDate = d && !isNaN(d.getTime())
            ? d.toLocaleString("ru-RU", { day: "numeric", month: "long", hour: "2-digit", minute: "2-digit" })
            : rawDate;

          card.innerHTML = `
            <form id="deleteForm_${user_id}" onsubmit="event.preventDefault(); saveMember(this)">
              <input type="hidden" name="user_id" value="${user_id}">
              <h3><input type="text" name="name" value="${info.name}"></h3>
              <input type="text" name="notes" value="${info.notes || ""}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
              <div class="meta">
                üíó ${info.total} | üìÖ ${info.login_count} –≤—Ö–æ–¥–æ–≤<br>
                üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: <span class="date" data-last-login="${rawDate}">${formattedDate}</span><br>
                üÜî ID: <code>${user_id}</code>
              </div>
              <div class="actions">
                <button type="submit">üíæ</button>
                <button type="button" onclick="removeMember('${user_id}')">üóëÔ∏è</button>
              </div>
            </form>
          `;
          grid.appendChild(card);
        });

        // –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞
        resortCards(currentSort);
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è VIP‚Äë–ª–∏—Å—Ç–∞:", e);
      }
    }

    // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
    async function refreshVipCard(userId) {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const info = data.members[userId];
        if (!info) return;

        const card = document.getElementById("card_" + userId);
        const newCard = document.createElement("div");
        newCard.className = "vip-card" + (info.blocked ? " blocked" : "");
        newCard.id = "card_" + userId;

        const rawDate = info.last_login || "";
        const d = rawDate ? new Date(rawDate.replace(" ", "T")) : null;
        const formattedDate = d && !isNaN(d.getTime())
          ? d.toLocaleString("ru-RU", { day: "numeric", month: "long", hour: "2-digit", minute: "2-digit" })
          : rawDate;

        newCard.innerHTML = `
          <form onsubmit="event.preventDefault(); saveMember(this)">
            <input type="hidden" name="user_id" value="${userId}">
            <h3><input type="text" name="name" value="${info.name}"></h3>
            <input type="text" name="notes" value="${info.notes || ""}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
            <div class="meta">
              üíó ${info.total} | üìÖ ${info.login_count} –≤—Ö–æ–¥–æ–≤<br>
              üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: <span class="date" data-last-login="${rawDate}">${formattedDate}</span><br>
              üÜî ID: <code>${userId}</code>
            </div>
            <div class="actions">
              <button type="submit">üíæ</button>
              <button type="button" onclick="removeMember('${userId}')">üóëÔ∏è</button>
              <button type="button" onclick="blockMember('${userId}')">üö´</button>
            </div>
          </form>
        `;

        if (card) {
          card.replaceWith(newCard);
        } else {
          document.querySelector(".card-grid").appendChild(newCard);
        }

        resortCards(currentSort);
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:", e);
      }
    }

    // –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    function resortCards(sortBy) {
      const grid = document.querySelector(".card-grid");
      const cards = Array.from(grid.children);

      cards.sort((a, b) => {
        if (sortBy === "last_login") {
          const dateA = new Date(a.querySelector(".date")?.dataset.lastLogin?.replace(" ", "T") || 0);
          const dateB = new Date(b.querySelector(".date")?.dataset.lastLogin?.replace(" ", "T") || 0);
          return dateB - dateA;
        }

        if (sortBy === "login_count") {
          const textA = a.querySelector(".meta").textContent;
          const textB = b.querySelector(".meta").textContent;
          const numA = parseInt((textA.match(/üìÖ\s*(\d+)\s*–≤—Ö–æ–¥/) || [])[1]);
          const numB = parseInt((textB.match(/üìÖ\s*(\d+)\s*–≤—Ö–æ–¥/) || [])[1]);
          return (numB || 0) - (numA || 0);
        }

        if (sortBy === "total") {
          const textA = a.querySelector(".meta").textContent;
          const textB = b.querySelector(".meta").textContent;
          const numA = parseFloat((textA.match(/üíó\s*([\d\.]+)/) || [])[1]);
          const numB = parseFloat((textB.match(/üíó\s*([\d\.]+)/) || [])[1]);
          return (numB || 0) - (numA || 0);
        }

        return 0;
      });

      grid.innerHTML = "";
      cards.forEach(c => grid.appendChild(c));
      console.log("‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (" + sortBy + ")");
    }

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("beforeunload", () => {
      localStorage.setItem("vip_scroll", window.scrollY);
    });

    // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    window.addEventListener("load", () => {
      const y = localStorage.getItem("vip_scroll");
      if (y) {
        window.scrollTo(0, parseInt(y));
      }
      // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ —Å—Ä–∞–∑—É
      refreshVipList();
    });

  </script>
  <script>
  let deleteId = null;

  function openDeleteModal(id) {
    deleteId = id;
    document.getElementById("modalOverlay").style.display = "block";
    document.getElementById("confirmModal").style.display = "block";
  }

  function closeDeleteModal() {
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("confirmModal").style.display = "none";
    deleteId = null;
  }

  document.getElementById("confirmYes").onclick = function() {
    if (deleteId) {
      document.getElementById("deleteForm_" + deleteId).submit();
    }
  };

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeDeleteModal();
  });
  </script>

  <div id="modalOverlay" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.4);
    z-index:1000;">
  </div>

  <div id="confirmModal" style="
    display:none;
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%, -50%);
    background:white;
    padding:20px 30px;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.2);
    z-index:1001;
    text-align:center;">
    
    <p style="margin-bottom:20px; font-size:18px;">–£–¥–∞–ª–∏—Ç—å VIP?</p>

    <button id="confirmYes" style="
      background:#f28497;
      color:white;
      padding:8px 20px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      margin-right:10px;">–î–∞</button>

    <button onclick="closeDeleteModal()" style="
      background:#a3d8f4;
      color:white;
      padding:8px 20px;
      border:none;
      border-radius:10px;
      cursor:pointer;">–ù–µ—Ç</button>
  </div>

</body>
</html>