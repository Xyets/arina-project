<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VIP‚Äë–ª–∏—Å—Ç</title>
  <link rel="icon" href="{{ url_for('static', filename='icon.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      margin: 0;
      padding: 40px;
      color: #333;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    header img {
      height: 60px;
    }

    header h1 {
      font-size: 28px;
      font-weight: 600;
      margin: 0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    .search-bar input {
      padding: 10px 15px;
      border-radius: 20px;
      border: 1px solid #ccc;
      width: 250px;
      font-size: 16px;
    }

    .search-bar button {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      background: #a3d8f4;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .vip-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
    }

    .vip-card.blocked {
      background: #ffe0e0;
    }

    .vip-card h3 {
      margin: 0 0 10px;
      font-size: 20px;
      color: #444;
    }

    .vip-card input[type="text"] {
      width: 100%;
      padding: 6px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: monospace;
    }

    .vip-card .meta {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .vip-card .actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .vip-card button {
      background: #f7a8b8;
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .vip-card button:hover {
      background: #f28497;
    }

    .sort-links a {
      margin-right: 10px;
      font-size: 14px;
      color: #888;
      text-decoration: none;
    }

    .sort-links a:hover {
      text-decoration: underline;
    }
  </style>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VIP‚Äë–ª–∏—Å—Ç</title>
  <link rel="icon" href="{{ url_for('static', filename='icon.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      margin: 0;
      padding: 40px;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    header img { height: 60px; }
    header h1 { font-size: 28px; font-weight: 600; margin: 0; }
    .top-bar {
      display: flex; justify-content: space-between; flex-wrap: wrap;
      gap: 20px; margin-bottom: 30px;
    }
    .search-bar input {
      padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc;
      width: 250px; font-size: 16px;
    }
    .search-bar button {
      padding: 10px 20px; border-radius: 20px; border: none;
      background: #a3d8f4; color: white; font-size: 16px; cursor: pointer;
    }
    .card-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .vip-card {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;
    }
    .vip-card.blocked { background: #ffe0e0; }
    .vip-card h3 { margin: 0 0 10px; font-size: 20px; color: #444; }
    .vip-card input[type="text"] {
      width: 100%; padding: 6px; margin-bottom: 8px;
      border-radius: 6px; border: 1px solid #ccc; font-family: monospace;
    }
    .vip-card .meta { font-size: 14px; color: #666; margin-bottom: 10px; }
    .vip-card .actions { display: flex; justify-content: space-between; gap: 8px; }
    .vip-card button {
      background: #f7a8b8; border: none; padding: 6px 12px;
      border-radius: 12px; color: white; cursor: pointer; font-size: 14px;
    }
    .vip-card button:hover { background: #f28497; }
    .sort-links a {
      margin-right: 10px; font-size: 14px; color: #888; text-decoration: none;
    }
    .sort-links a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo">
    <h1>VIP‚Äë–ª–∏—Å—Ç –¥–ª—è {{ user }}</h1>
  </header>

  <div class="top-bar">
    <form method="GET" action="/vip" class="search-bar">
      <input type="text" name="q" placeholder="üîç –ü–æ–∏—Å–∫..." value="{{ query }}">
      <button type="submit">–ù–∞–π—Ç–∏</button>
      {% if query %}<a href="/vip">–°–±—Ä–æ—Å–∏—Ç—å</a>{% endif %}
    </form>

    <div class="sort-links">
      <a href="/vip?sort=total">üíó –ü–æ —á–∞–µ–≤—ã–º</a>
      <a href="/vip?sort=login_count">üìÖ –ü–æ –≤–∏–∑–∏—Ç–∞–º</a>
      <a href="/vip?sort=last_login">üïí –ü–æ –¥–∞—Ç–µ</a>
    </div>

    <form method="POST" action="/clear_vip">
      <button>üßπ –û—á–∏—Å—Ç–∏—Ç—å VIP‚Äë–ª–∏—Å—Ç</button>
    </form>
  </div>

  <div class="card-grid">
    {% for user_id, info in members %}
    <div class="vip-card {% if info.blocked %}blocked{% endif %}" id="card_{{ user_id }}">
      <form method="POST">
        <input type="hidden" name="user_id" value="{{ user_id }}">
        <input type="hidden" name="sort" value="{{ request.args.get('sort', 'total') }}">
        <input type="hidden" name="q" value="{{ query }}">
  
        <h3><input type="text" name="name" value="{{ info.name }}"></h3>
        <input type="text" name="notes" value="{{ info.notes }}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
        <div class="meta">
          üíó {{ info.total }} | üìÖ {{ info.login_count }} –≤—Ö–æ–¥–æ–≤<br>
          üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: <span class="date">{{ info.last_login }}</span><br>
          üÜî ID: <code>{{ user_id }}</code>
        </div>
        <div class="actions">
          <button type="submit">üíæ</button>
          <button type="button" onclick="removeMember('{{ user_id }}')">üóëÔ∏è</button>
          <button type="button" onclick="blockMember('{{ user_id }}')">üö´</button>
        </div>
      </form>
    </div>
    {% endfor %}
  </div>

  <script>
    // AJAX‚Äë—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    async function saveMember(form) {
      const formData = new FormData(form);

      try {
        const res = await fetch("/vip", {
          method: "POST",
          body: formData
        });

        if (res.ok) {
          console.log("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");

          // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–Ω–æ–≤–æ –∏–∑ /vip_data
          const userId = form.querySelector("input[name='user_id']").value;
          await refreshVipCard(userId);

          // –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          resortCards("{{ request.args.get('sort', 'total') }}");
        } else {
          alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ AJAX‚Äë—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      }
    }

    function removeMember(userId) {
      fetch("/remove_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.remove();
        } else {
          alert("‚ùå " + data.message);
        }
      })
      .catch(() => alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"));
    }

    function blockMember(userId) {
      fetch("/block_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.classList.add("blocked");
        } else {
          alert("‚ùå " + data.message);
        }
      })
      .catch(() => alert("‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"));
    }

    // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    document.querySelectorAll(".date").forEach(el => {
      const raw = el.textContent.trim();
      if (!raw) return;
      const iso = raw.replace(" ", "T");
      const d = new Date(iso);
      if (!isNaN(d.getTime())) {
        el.textContent = d.toLocaleString("ru-RU", {
          day: "numeric",
          month: "long",
          hour: "2-digit",
          minute: "2-digit"
        });
      }
    });

    // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    let socket;
    function connectWS() {
      socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

      socket.onopen = () => console.log("‚úÖ WS –æ—Ç–∫—Ä—ã—Ç");
      socket.onclose = () => {
        console.log("‚ùå WS –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.vip_update && data.user_id) {
          console.log("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É:", data.user_id);
          refreshVipCard(data.user_id).then(() => {
            resortCards("{{ request.args.get('sort', 'total') }}");
          });
        }
      };
    }
    connectWS();

    // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞
    async function refreshVipList() {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const grid = document.querySelector(".card-grid");
        grid.innerHTML = "";

        Object.entries(data.members || {}).forEach(([user_id, info]) => {
          const card = document.createElement("div");
          card.className = "vip-card" + (info.blocked ? " blocked" : "");
          card.id = "card_" + user_id;
          card.innerHTML = `
            <form onsubmit="event.preventDefault(); saveMember(this)">
              <input type="hidden" name="user_id" value="${user_id}">
              <h3><input type="text" name="name" value="${info.name}"></h3>
              <input type="text" name="notes" value="${info.notes || ""}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
              <div class="meta">
                üíó ${info.total} | üìÖ ${info.login_count} –≤—Ö–æ–¥–æ–≤<br>
                üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: ${info.last_login}<br>
                üÜî ID: <code>${user_id}</code>
              </div>
              <div class="actions">
                <button type="submit">üíæ</button>
                <button type="button" onclick="removeMember('${user_id}')">üóëÔ∏è</button>
                <button type="button" onclick="blockMember('${user_id}')">üö´</button>
              </div>
            </form>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è VIP‚Äë–ª–∏—Å—Ç–∞:", e);
      }
    }

    // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
    async function refreshVipCard(userId) {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const info = data.members[userId];
        if (!info) return;

        const card = document.getElementById("card_" + userId);
        const newCard = document.createElement("div");
        newCard.className = "vip-card" + (info.blocked ? " blocked" : "");
        newCard.id = "card_" + userId;

        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É –≤ data-last-login –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const rawDate = info.last_login;
        const d = new Date(rawDate.replace(" ", "T"));
        const formattedDate = !isNaN(d.getTime())
          ? d.toLocaleString("ru-RU", {
              day: "numeric",
              month: "long",
              hour: "2-digit",
              minute: "2-digit"
            })
          : rawDate;

        newCard.innerHTML = `
          <form onsubmit="event.preventDefault(); saveMember(this)">
            <input type="hidden" name="user_id" value="${userId}">
            <h3><input type="text" name="name" value="${info.name}"></h3>
            <input type="text" name="notes" value="${info.notes || ""}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
            <div class="meta">
              üíó ${info.total} | üìÖ ${info.login_count} –≤—Ö–æ–¥–æ–≤<br>
              üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: <span class="date" data-last-login="${rawDate}">${formattedDate}</span><br>
              üÜî ID: <code>${userId}</code>
            </div>
            <div class="actions">
              <button type="submit">üíæ</button>
              <button type="button" onclick="removeMember('${userId}')">üóëÔ∏è</button>
              <button type="button" onclick="blockMember('${userId}')">üö´</button>
            </div>
          </form>
        `;

        if (card) {
          card.replaceWith(newCard);
        } else {
          document.querySelector(".card-grid").appendChild(newCard);
        }

        // –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
        resortCards("{{ request.args.get('sort', 'total') }}");
      } catch (e) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:", e);
      }
    }

    // –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    function resortCards(sortBy) {
      const grid = document.querySelector(".card-grid");
      const cards = Array.from(grid.children);

      cards.sort((a, b) => {
        if (sortBy === "last_login") {
          const dateA = new Date(a.querySelector(".date")?.dataset.lastLogin || 0);
          const dateB = new Date(b.querySelector(".date")?.dataset.lastLogin || 0);
          return dateB - dateA;
        }
        if (sortBy === "login_count") {
          const textA = a.querySelector(".meta").textContent;
          const textB = b.querySelector(".meta").textContent;
          const numA = parseInt(textA.match(/(\d+) –≤—Ö–æ–¥/));
          const numB = parseInt(textB.match(/(\d+) –≤—Ö–æ–¥/));
          return (numB || 0) - (numA || 0);
        }
        if (sortBy === "total") {
          const textA = a.querySelector(".meta").textContent;
          const textB = b.querySelector(".meta").textContent;
          const numA = parseInt(textA.match(/üíó\s*(\d+)/));
          const numB = parseInt(textB.match(/üíó\s*(\d+)/));
          return (numB || 0) - (numA || 0);
        }
        return 0;
      });

      grid.innerHTML = "";
      cards.forEach(c => grid.appendChild(c));
      console.log("‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (" + sortBy + ")");
    }

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("beforeunload", () => {
      localStorage.setItem("vip_scroll", window.scrollY);
    });

    // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    window.addEventListener("load", () => {
      const y = localStorage.getItem("vip_scroll");
      if (y) {
        window.scrollTo(0, parseInt(y));
      }
    });
  </script>

</body>
</html>