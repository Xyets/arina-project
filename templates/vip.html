<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VIPâ€‘Ğ»Ğ¸ÑÑ‚</title>
  <link rel="icon" href="{{ url_for('static', filename='icon.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      margin: 0;
      padding: 40px;
      color: #333;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    header img {
      height: 60px;
    }

    header h1 {
      font-size: 28px;
      font-weight: 600;
      margin: 0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    .search-bar input {
      padding: 10px 15px;
      border-radius: 20px;
      border: 1px solid #ccc;
      width: 250px;
      font-size: 16px;
    }

    .search-bar button {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      background: #a3d8f4;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .vip-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
    }

    .vip-card.blocked {
      background: #ffe0e0;
    }

    .vip-card h3 {
      margin: 0 0 10px;
      font-size: 20px;
      color: #444;
    }

    .vip-card input[type="text"] {
      width: 100%;
      padding: 6px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: monospace;
    }

    .vip-card .meta {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .vip-card .actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .vip-card button {
      background: #f7a8b8;
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .vip-card button:hover {
      background: #f28497;
    }

    .sort-links a {
      margin-right: 10px;
      font-size: 14px;
      color: #888;
      text-decoration: none;
    }

    .sort-links a:hover {
      text-decoration: underline;
    }
  </style>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VIPâ€‘Ğ»Ğ¸ÑÑ‚</title>
  <link rel="icon" href="{{ url_for('static', filename='icon.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      margin: 0;
      padding: 40px;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    header img { height: 60px; }
    header h1 { font-size: 28px; font-weight: 600; margin: 0; }
    .top-bar {
      display: flex; justify-content: space-between; flex-wrap: wrap;
      gap: 20px; margin-bottom: 30px;
    }
    .search-bar input {
      padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc;
      width: 250px; font-size: 16px;
    }
    .search-bar button {
      padding: 10px 20px; border-radius: 20px; border: none;
      background: #a3d8f4; color: white; font-size: 16px; cursor: pointer;
    }
    .card-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .vip-card {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative;
    }
    .vip-card.blocked { background: #ffe0e0; }
    .vip-card h3 { margin: 0 0 10px; font-size: 20px; color: #444; }
    .vip-card input[type="text"] {
      width: 100%; padding: 6px; margin-bottom: 8px;
      border-radius: 6px; border: 1px solid #ccc; font-family: monospace;
    }
    .vip-card .meta { font-size: 14px; color: #666; margin-bottom: 10px; }
    .vip-card .actions { display: flex; justify-content: space-between; gap: 8px; }
    .vip-card button {
      background: #f7a8b8; border: none; padding: 6px 12px;
      border-radius: 12px; color: white; cursor: pointer; font-size: 14px;
    }
    .vip-card button:hover { background: #f28497; }
    .sort-links a {
      margin-right: 10px; font-size: 14px; color: #888; text-decoration: none;
    }
    .sort-links a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <img src="{{ url_for('static', filename='icon.png') }}" alt="Logo">
    <h1>VIPâ€‘Ğ»Ğ¸ÑÑ‚ Ğ´Ğ»Ñ {{ user }}</h1>
  </header>

  <div class="top-bar">
    <form method="GET" action="/vip" class="search-bar">
      <input type="text" name="q" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº..." value="{{ query }}">
      <button type="submit">ĞĞ°Ğ¹Ñ‚Ğ¸</button>
      {% if query %}<a href="/vip">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</a>{% endif %}
    </form>

    <div class="sort-links">
      <a href="/vip?sort=total">ğŸ’— ĞŸĞ¾ Ñ‡Ğ°ĞµĞ²Ñ‹Ğ¼</a>
      <a href="/vip?sort=login_count">ğŸ“… ĞŸĞ¾ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ°Ğ¼</a>
      <a href="/vip?sort=last_login">ğŸ•’ ĞŸĞ¾ Ğ´Ğ°Ñ‚Ğµ</a>
    </div>

    <form method="POST" action="/clear_vip">
      <button>ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ VIPâ€‘Ğ»Ğ¸ÑÑ‚</button>
    </form>
  </div>

  <div class="card-grid">
    {% for user_id, info in members %}
    <div class="vip-card {% if info.blocked %}blocked{% endif %}" id="card_{{ user_id }}">
      <form method="POST">
        <input type="hidden" name="user_id" value="{{ user_id }}">
        <input type="hidden" name="sort" value="{{ request.args.get('sort', 'total') }}">
        <input type="hidden" name="q" value="{{ query }}">
  
        <h3><input type="text" name="name" value="{{ info.name }}"></h3>
        <input type="text" name="notes" value="{{ info.notes }}" placeholder="Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸">
        <div class="meta">
          ğŸ’— {{ info.total }} | ğŸ“… {{ info.login_count }} Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ²<br>
          ğŸ•’ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚: <span class="date">{{ info.last_login }}</span><br>
          ğŸ†” ID: <code>{{ user_id }}</code>
        </div>
        <div class="actions">
          <button type="submit">ğŸ’¾</button>
          <button type="button" onclick="removeMember('{{ user_id }}')">ğŸ—‘ï¸</button>
          <button type="button" onclick="blockMember('{{ user_id }}')">ğŸš«</button>
        </div>
      </form>
    </div>
    {% endfor %}
  </div>

  <script>
    // AJAXâ€‘ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸
    async function saveMember(form) {
      const formData = new FormData(form);

      try {
        const res = await fetch("/vip", {
          method: "POST",
          body: formData
        });

        if (res.ok) {
          console.log("âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾");

          // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾ Ğ¸Ğ· /vip_data
          const userId = form.querySelector("input[name='user_id']").value;
          await refreshVipCard(userId);

          // Ğ¿ĞµÑ€ĞµÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
          resortCards("{{ request.args.get('sort', 'total') }}");
        } else {
          alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ");
        }
      } catch (e) {
        console.warn("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° AJAXâ€‘ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ:", e);
        alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ");
      }
    }

    function removeMember(userId) {
      fetch("/remove_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.remove();
        } else {
          alert("âŒ " + data.message);
        }
      })
      .catch(() => alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"));
    }

    function blockMember(userId) {
      fetch("/block_member", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "user_id=" + encodeURIComponent(userId)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById("card_" + userId)?.classList.add("blocked");
        } else {
          alert("âŒ " + data.message);
        }
      })
      .catch(() => alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸"));
    }

    // Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ
    document.querySelectorAll(".date").forEach(el => {
      const raw = el.textContent.trim();
      if (!raw) return;
      const iso = raw.replace(" ", "T");
      const d = new Date(iso);
      if (!isNaN(d.getTime())) {
        el.textContent = d.toLocaleString("ru-RU", {
          day: "numeric",
          month: "long",
          hour: "2-digit",
          minute: "2-digit"
        });
      }
    });

    // Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº WebSocket
    let socket;
    function connectWS() {
      socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

      socket.onopen = () => console.log("âœ… WS Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚");
      socket.onclose = () => {
        console.log("âŒ WS Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚, Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ...");
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.vip_update && data.user_id) {
          console.log("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ:", data.user_id);
          refreshVipCard(data.user_id).then(() => {
            resortCards("{{ request.args.get('sort', 'total') }}");
          });
        }
      };
    }
    connectWS();

    // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°
    async function refreshVipList() {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const grid = document.querySelector(".card-grid");
        grid.innerHTML = "";

        Object.entries(data.members || {}).forEach(([user_id, info]) => {
          const card = document.createElement("div");
          card.className = "vip-card" + (info.blocked ? " blocked" : "");
          card.id = "card_" + user_id;
          card.innerHTML = `
            <form onsubmit="event.preventDefault(); saveMember(this)">
              <input type="hidden" name="user_id" value="${user_id}">
              <h3><input type="text" name="name" value="${info.name}"></h3>
              <input type="text" name="notes" value="${info.notes || ""}" placeholder="Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸">
              <div class="meta">
                ğŸ’— ${info.total} | ğŸ“… ${info.login_count} Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ²<br>
                ğŸ•’ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚: ${info.last_login}<br>
                ğŸ†” ID: <code>${user_id}</code>
              </div>
              <div class="actions">
                <button type="submit">ğŸ’¾</button>
                <button type="button" onclick="removeMember('${user_id}')">ğŸ—‘ï¸</button>
                <button type="button" onclick="blockMember('${user_id}')">ğŸš«</button>
              </div>
            </form>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.warn("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ VIPâ€‘Ğ»Ğ¸ÑÑ‚Ğ°:", e);
      }
    }

    // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸
    async function refreshVipCard(userId) {
      try {
        const res = await fetch("/vip_data");
        const data = await res.json();
        const info = data.members[userId];
        if (!info) return;

        const card = document.getElementById("card_" + userId);
        const newCard = document.createElement("div");
        newCard.className = "vip-card" + (info.blocked ? " blocked" : "");
        newCard.id = "card_" + userId;
        newCard.innerHTML = `
          <form onsubmit="event.preventDefault(); saveMember(this)">
            <input type="hidden" name="user_id" value="${userId}">
            <h3><input type="text" name="name" value="${info.name}"></h3>
            <input type="text" name="notes" value="${info.notes || ""}" placeholder="Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸">
            <div class="meta">
              ğŸ’— ${info.total} | ğŸ“… ${info.login_count} Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ²<br>
              ğŸ•’ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ·Ğ¸Ñ‚: <span class="date">${info.last_login}</span><br>
              ğŸ†” ID: <code>${userId}</code>
            </div>
            <div class="actions">
              <button type="submit">ğŸ’¾</button>
              <button type="button" onclick="removeMember('${userId}')">ğŸ—‘ï¸</button>
              <button type="button" onclick="blockMember('${userId}')">ğŸš«</button>
            </div>
          </form>
        `;

        if (card) {
          card.replaceWith(newCard);
        } else {
          document.querySelector(".card-grid").appendChild(newCard);
        }

        // ğŸ‘‰ Ğ¿ĞµÑ€ĞµÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸
        resortCards("{{ request.args.get('sort', 'total') }}");
      } catch (e) {
        console.warn("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸:", e);
      }
    }


    // Ğ¿ĞµÑ€ĞµÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
    function resortCards(sortBy) {
      const grid = document.querySelector(".card-grid");
      const cards = Array.from(grid.children);

      cards.sort((a, b) => {
        if (sortBy === "last_login") {
          const dateA = new Date(a.querySelector(".date")?.textContent || 0);
          const dateB = new Date(b.querySelector(".date")?.textContent || 0);
          return dateB - dateA;
        }
        if (sortBy === "login_count") {
          const textA = a.querySelector(".meta").textContent;
          const textB = b.querySelector(".meta").textContent;
          const numA = parseInt(textA.match(/(\d+) Ğ²Ñ…Ğ¾Ğ´/));
          const numB = parseInt(textB.match(/(\d+) Ğ²Ñ…Ğ¾Ğ´/));
          return (numB || 0) - (numA || 0);
        }
        if (sortBy === "total") {
          const textA = a.querySelector(".meta").textContent;
          const textB = b.querySelector(".meta").textContent;
          const numA = parseInt(textA.match(/ğŸ’—\s*(\d+)/));
          const numB = parseInt(textB.match(/ğŸ’—\s*(\d+)/));
          return (numB || 0) - (numA || 0);
        }
        return 0;
      });

      grid.innerHTML = "";
      cards.forEach(c => grid.appendChild(c));
    }
  </script>

</body>
</html>