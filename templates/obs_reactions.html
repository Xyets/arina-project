<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>OBS Reactions</title>
  <style>
    body {
      margin:0;
      background:transparent;
      text-align:center;
    }
    #reactionArea img {
      max-width:400px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      opacity:0;
      transition: opacity 1s ease-in-out;
    }
    #reactionArea img.show {
      opacity:1;
    }
  </style>
</head>
<body data-profile="{{ profile_key }}">
  <div id="reactionArea"></div>

  <script>
    const reactionArea = document.getElementById("reactionArea");
    const profileKey = document.body.dataset.profile;
    console.log("profileKey Ð¸Ð· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°:", profileKey);

    const socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

    socket.onopen = () => console.log("ðŸ”Œ WebSocket Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½");

    socket.onmessage = (event) => {
      console.log("ðŸ“© WS raw:", event.data);
      let data;
      try { data = JSON.parse(event.data); } catch(e) {
        console.error("âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°:", e);
        return;
      }
      console.log("ðŸ“© WS parsed:", data, "profileKey:", profileKey);

      if (data.reaction && data.profile === profileKey) {
        console.log("âœ… Reaction matched:", data.reaction);
        fetch(`/reaction_image/${data.profile}/${data.reaction}`)
          .then(res => {
            if (!res.ok) throw new Error("HTTP error " + res.status);
            return res.json();
          })
          .then(info => {
            console.log("ðŸ“¥ reaction_image:", info);
            if (info.image) {
              reactionArea.innerHTML = `<img src="/static/${info.image}" alt="Reaction">`;
              const img = reactionArea.querySelector("img");
              if (!img) return;

              // Ð¿Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ðµ
              setTimeout(() => img.classList.add("show"), 50);

              // Ð±ÐµÑ€Ñ‘Ð¼ duration Ð¸Ð· JSON, Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 5 ÑÐµÐºÑƒÐ½Ð´
              const durationMs = (info.duration || 5) * 1000;

              setTimeout(() => {
                img.classList.remove("show");
                setTimeout(() => reactionArea.innerHTML = "", 1000);
                console.log("ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸ (duration:", durationMs, "ms)");
              }, durationMs);
            } else {
              console.warn("âŒ ÐÐµÑ‚ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ Ð´Ð»Ñ Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸");
            }
          })
          .catch(err => console.error("âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° reaction_image:", err));
      } else {
        console.warn("âš ï¸ Reaction ignored: profile mismatch or no reaction");
      }
    };

    socket.onclose = () => console.log("ðŸ”Œ WebSocket Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ñ‘Ð½");
  </script>
</body>
</html>
