<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>OBS Reactions</title>
  <style>
    body { margin:0; background:transparent; text-align:center; }
    #reactionArea img { max-width:400px; }
    .vibration-gif { width:200px; height:auto; display:inline; }
    @keyframes pulse {
      0% { transform: scale(1); }
      25% { transform: scale(1.25); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div id="reactionArea"></div>
  <img src="{{ url_for('static', filename='irina.png') }}" id="gifIrina" class="vibration-gif" />

  <script>
    const reactionArea = document.getElementById("reactionArea");
    const gif = document.getElementById("gifIrina");
    let vibrationQueue = [];
    let isPlaying = false;

    function playNext() {
      if (isPlaying || vibrationQueue.length === 0) return;
      const { strength, duration } = vibrationQueue.shift();
      isPlaying = true;

      let s = strength;
      if (isNaN(s) || s < 1) s = 1;
      if (s > 20) s = 20;

      let speed = 1.5 - (s * 0.06);
      if (speed < 0.25) speed = 0.25;
      const scale = 1 + (s / 8);
      const glowSize = s * 4;
      const glowOpacity = 0.5 + s / 20;

      gif.style.animation = `pulse ${speed}s ease-in-out infinite`;
      gif.style.transform = `scale(${scale})`;
      gif.style.filter = `drop-shadow(0 0 ${glowSize}px rgba(30,144,255,${glowOpacity}))`;

      setTimeout(() => {
        gif.style.animation = "";
        gif.style.transform = "scale(1)";
        gif.style.filter = "drop-shadow(0 0 8px rgba(30,144,255,0.4))";
        isPlaying = false;
        playNext();
      }, duration * 1000);
    }

    function enqueueVibration(strength, duration) {
      vibrationQueue.push({ strength, duration });
      playNext();
    }

    function showReaction(profileKey, ruleId) {
      fetch(`/reaction_image/${profileKey}/${ruleId}`)
        .then(res => res.json())
        .then(info => {
          if (info.image) {
            reactionArea.innerHTML = `<img src="/static/${info.image}" />`;
            setTimeout(() => reactionArea.innerHTML = "", 5000);
          }
        });
    }

    // ðŸŒ WebSocket
    let socket = new WebSocket("wss://arinairina.duckdns.org/ws/");
    socket.onmessage = (event) => {
      let data; try { data = JSON.parse(event.data); } catch { return; }
      if (data.vibration && data.vibration.target === "{{ profile.uname }}") {
        enqueueVibration(data.vibration.strength, data.vibration.duration);
      } else if (data.reaction && data.profile === "{{ profile_key }}") {
        showReaction(data.profile, data.reaction);
      }
    };
  </script>
</body>
</html>
