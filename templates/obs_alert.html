<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>OBS Alert</title>
  <style>
    body { margin:0; background:transparent; overflow:hidden; font-family: 'Poppins', sans-serif; }
    .alert {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.7); border-radius:20px; padding:20px 40px;
      font-size:28px; color:#fff; text-shadow:2px 2px 5px #000;
      opacity:0; transition:opacity 0.5s;
    }
    .alert.show { opacity:1; animation: fadeOut 6s forwards; }
    @keyframes fadeOut { 0%{opacity:1;} 100%{opacity:0;} }

    /* –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ */
    .confetti {
      position: fixed;
      width: 10px; height: 10px;
      background: red;
      animation: fall 3s linear forwards;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(360deg); opacity:0; }
    }

    /* –°–µ—Ä–¥–µ—á–∫–∏ */
    .heart {
      position: fixed;
      font-size: 24px;
      animation: floatUp 3s linear forwards;
    }
    @keyframes floatUp {
      to { transform: translateY(-100vh); opacity:0; }
    }
  </style>
</head>
<body>
  <div class="alert" id="alertBox">
    üéâ <span id="eventType"></span><br>
    üë§ <span id="donator"></span> | üí∞ <span id="amount"></span>
  </div>

  <audio id="sound" src="/static/alert.mp3"></audio>

  <script>
    let socket;

    function connectWS() {
      socket = new WebSocket("wss://arinairina.duckdns.org/ws/");

      socket.onopen = () => {
        console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        socket._pingInterval = setInterval(() => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "ping" }));
          }
        }, 30000);
      };

      socket.onclose = () => {
        console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
        if (socket._pingInterval) clearInterval(socket._pingInterval);
        setTimeout(connectWS, 2000);
      };

      socket.onmessage = (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        // --- –î–æ–Ω–∞—Ç (vibration) ---
        if (data.vibration) {
          const { strength, duration, target } = data.vibration;
          document.getElementById("eventType").textContent = "–î–æ–Ω–∞—Ç";
          document.getElementById("donator").textContent = target;
          document.getElementById("amount").textContent =
            `—Å–∏–ª–∞=${strength}, –≤—Ä–µ–º—è=${duration}s`;

          if (strength === 1) {
            // üíñ —Å–µ—Ä–¥–µ—á–∫–∏
            for (let i=0; i<20; i++) {
              const heart = document.createElement("div");
              heart.className = "heart";
              heart.textContent = "üíñ";
              heart.style.left = Math.random()*100 + "vw";
              heart.style.top = "100vh";
              document.body.appendChild(heart);
              setTimeout(()=>heart.remove(), 3000);
            }
          } else {
            // üéâ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
            for (let i=0; i<30; i++) {
              const conf = document.createElement("div");
              conf.className = "confetti";
              conf.style.left = Math.random()*100 + "vw";
              conf.style.background = `hsl(${Math.random()*360},100%,50%)`;
              document.body.appendChild(conf);
              setTimeout(()=>conf.remove(), 3000);
            }
          }
        }

        // --- –í—Ö–æ–¥ VIP (entry) ---
        if (data.entry) {
          document.getElementById("eventType").textContent = "–í—Ö–æ–¥ VIP";
          document.getElementById("donator").textContent = data.entry.name;
          document.getElementById("amount").textContent =
            `–í—Ö–æ–¥–æ–≤: ${data.entry.visits}, –î–æ–Ω–∞—Ç–æ–≤: ${data.entry.total_tips}`;
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ VIP (vip_update) ---
        if (data.vip_update) {
          document.getElementById("eventType").textContent = "VIP –æ–±–Ω–æ–≤–ª—ë–Ω";
          document.getElementById("donator").textContent = data.user_id || "";
          document.getElementById("amount").textContent = "";
        }

        // –ø–æ–∫–∞–∑–∞—Ç—å –∞–ª–µ—Ä—Ç
        const box = document.getElementById("alertBox");
        box.classList.add("show");
        setTimeout(()=>box.classList.remove("show"), 6000);

        // –∑–≤—É–∫
        document.getElementById("sound").play();
      };
    }

    connectWS();
  </script>
</body>
</html>
